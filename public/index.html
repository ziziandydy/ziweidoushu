<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç´«å¾®æ–—æ•¸å‘½ç›¤</title>

    <!-- Google Tag Manager -->
    <script>(function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({
                'gtm.start':
                    new Date().getTime(), event: 'gtm.js'
            }); var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
                    'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-WJJN3TGM');</script>
    <!-- End Google Tag Manager -->

    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3240143153468832"
        crossorigin="anonymous"></script>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="alternate icon" href="/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ziwei: {
                            purple: '#9333ea',
                            gold: '#f59e0b',
                            blue: '#3b82f6',
                            green: '#10b981'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loading-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }
    </style>

    <!-- è¿½è¹¤ä»£ç¢¼ -->
    <script type="text/javascript">
            (function () {
                var u = 'https://violet.ghtinc.com/tracking/groundhogSensitiveCookie';
                var g = document.createElement('script');
                g.type = 'text/javascript';
                g.async = true;
                g.src = u;
                document.getElementsByTagName('head')[0].appendChild(g);
            })();

        var _ghq = (window._ghq = window._ghq || []);
        (function (t) {
            var u = 'https://violet.ghtinc.com/tracking',
                j = document.createElement('script');

            _ghq.push(['setTrackerUrl', u + '/track/v2']);
            _ghq.push(['setTrackerId', t]);

            j.type = 'text/javascript';
            j.async = true;
            j.src = u + '/groundhog-tracker.js';
            document.getElementsByTagName('head')[0].appendChild(j);
        })('68df4f5ed57cf360760a2d65');
    </script>

    <script>
        window._ghq?.push(['trackEvent', 'track', 'PageView']);
    </script>
</head>

<body class="min-h-screen bg-gray-100">
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WJJN3TGM" height="0" width="0"
            style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <div class="min-h-screen">
        <!-- å´é‚Šæ¬„å»£å‘Š - å·¦å´ -->
        <div class="fixed left-4 top-1/2 transform -translate-y-1/2 hidden xl:block w-32 h-96 z-10">
            <div class="text-center text-xs text-gray-500 mb-2">å»£å‘Š</div>
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-2">
                <!-- Google AdSense - å´é‚Šæ¬„ -->
                <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3240143153468832"
                    data-ad-slot="7607800035" data-ad-format="auto" data-full-width-responsive="true"></ins>
                <script>
                    (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
            </div>
        </div>

        <!-- å´é‚Šæ¬„å»£å‘Š - å³å´ -->
        <div class="fixed right-4 top-1/2 transform -translate-y-1/2 hidden xl:block w-32 h-96 z-10">
            <div class="text-center text-xs text-gray-500 mb-2">å»£å‘Š</div>
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-2">
                <!-- Google AdSense - å´é‚Šæ¬„ -->
                <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3240143153468832"
                    data-ad-slot="7607800035" data-ad-format="auto" data-full-width-responsive="true"></ins>
                <script>
                    (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
            </div>
        </div>

        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="w-full max-w-2xl bg-white rounded-xl shadow-lg p-6">
                <!-- æ¨™é¡Œ -->
                <div class="flex items-center justify-center mb-6">
                    <svg class="w-6 h-6 mr-2 text-ziwei-purple" fill="currentColor" viewBox="0 0 24 24">
                        <path
                            d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                    </svg>
                    <h1 class="text-3xl font-bold text-center">ç´«å¾®æ–—æ•¸å‘½ç›¤</h1>
                </div>

                <p class="text-center text-gray-600 mb-8">éµå¾ªä¸­å·æ´¾å‚³çµ±ç†è«– Â· ä¸»é æ•´åˆç‰ˆæœ¬</p>

                <!-- æ­¥é©ŸæŒ‡ç¤ºå™¨ -->
                <div class="flex justify-center mb-8 space-x-4">
                    <div id="step-1" class="flex items-center">
                        <div
                            class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center text-sm font-medium">
                            1</div>
                        <span class="ml-2 text-blue-600 font-medium">åŸºæœ¬è³‡æ–™</span>
                    </div>
                    <div id="step-2" class="flex items-center">
                        <div
                            class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center text-sm font-medium">
                            2</div>
                        <span class="ml-2 text-gray-400 font-medium">å‘½ç›¤åœ–è¡¨</span>
                    </div>
                    <div id="step-3" class="flex items-center">
                        <div
                            class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center text-sm font-medium">
                            3</div>
                        <span class="ml-2 text-gray-400 font-medium">å‘½ç›¤æ˜Ÿæ›œ</span>
                    </div>
                    <div id="step-4" class="flex items-center">
                        <div
                            class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center text-sm font-medium">
                            4</div>
                        <span class="ml-2 text-gray-400 font-medium">è©³ç´°è§£æ</span>
                    </div>
                </div>

                <!-- æ­¥é©Ÿä¸€ï¼šåŸºæœ¬è³‡æ–™è¼¸å…¥ -->
                <div id="step-content-1" class="animate-fade-in">
                    <h2 class="text-2xl font-bold mb-6 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-blue-500" fill="currentColor" viewBox="0 0 24 24">
                            <path
                                d="M9 16.171l9.594-9.594L17.172 5.84 11.5 11.512 6.828 6.84 5.406 8.264 11.5 14.358z" />
                        </svg>
                        å€‹äººåŸºæœ¬è³‡æ–™
                    </h2>

                    <div class="space-y-6">
                        <!-- å§“åå’Œæ€§åˆ¥ -->
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block mb-2 font-medium">å§“å</label>
                                <input type="text" id="user-name"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                                    placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å" />
                            </div>

                            <div>
                                <label class="block mb-2 font-medium">æ€§åˆ¥</label>
                                <div class="flex space-x-2">
                                    <button id="gender-male"
                                        class="flex-1 py-3 rounded-lg border transition-colors font-medium bg-blue-500 text-white border-blue-500">
                                        ç”·
                                    </button>
                                    <button id="gender-female"
                                        class="flex-1 py-3 rounded-lg border transition-colors font-medium bg-white text-gray-700 border-gray-300 hover:bg-gray-50">
                                        å¥³
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- æ›†æ³•é¡å‹ -->
                        <div>
                            <label class="block mb-2 font-medium">æ›†æ³•é¡å‹</label>
                            <div class="flex space-x-2">
                                <button id="calendar-solar"
                                    class="flex-1 py-3 rounded-lg border transition-colors font-medium bg-green-500 text-white border-green-500">
                                    è¥¿æ›†
                                </button>
                                <button id="calendar-lunar"
                                    class="flex-1 py-3 rounded-lg border transition-colors font-medium bg-white text-gray-700 border-gray-300 hover:bg-gray-50">
                                    è¾²æ›†
                                </button>
                            </div>
                        </div>

                        <!-- å‡ºç”Ÿæ—¥æœŸ -->
                        <div class="grid md:grid-cols-3 gap-4">
                            <div>
                                <label class="block mb-2 font-medium">å‡ºç”Ÿå¹´</label>
                                <select id="birth-year"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">é¸æ“‡å¹´ä»½</option>
                                </select>
                            </div>

                            <div>
                                <label class="block mb-2 font-medium">å‡ºç”Ÿæœˆ</label>
                                <select id="birth-month"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">é¸æ“‡æœˆä»½</option>
                                </select>
                            </div>

                            <div>
                                <label class="block mb-2 font-medium">å‡ºç”Ÿæ—¥</label>
                                <select id="birth-day"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">é¸æ“‡æ—¥æœŸ</option>
                                </select>
                            </div>
                        </div>

                        <!-- å‡ºç”Ÿæ™‚è¾° -->
                        <div>
                            <label class="block mb-2 font-medium flex items-center">
                                <svg class="w-4 h-4 mr-1 text-gray-500" fill="currentColor" viewBox="0 0 24 24">
                                    <path
                                        d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z" />
                                    <polyline points="12,6 12,12 16,14" />
                                </svg>
                                å‡ºç”Ÿæ™‚è¾°
                            </label>
                            <select id="birth-hour"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">é¸æ“‡æ™‚è¾°</option>
                                <option value="å­æ™‚">å­æ™‚ (23:00-01:00)</option>
                                <option value="ä¸‘æ™‚">ä¸‘æ™‚ (01:00-03:00)</option>
                                <option value="å¯…æ™‚">å¯…æ™‚ (03:00-05:00)</option>
                                <option value="å¯æ™‚">å¯æ™‚ (05:00-07:00)</option>
                                <option value="è¾°æ™‚">è¾°æ™‚ (07:00-09:00)</option>
                                <option value="å·³æ™‚">å·³æ™‚ (09:00-11:00)</option>
                                <option value="åˆæ™‚">åˆæ™‚ (11:00-13:00)</option>
                                <option value="æœªæ™‚">æœªæ™‚ (13:00-15:00)</option>
                                <option value="ç”³æ™‚">ç”³æ™‚ (15:00-17:00)</option>
                                <option value="é…‰æ™‚">é…‰æ™‚ (17:00-19:00)</option>
                                <option value="æˆŒæ™‚">æˆŒæ™‚ (19:00-21:00)</option>
                                <option value="äº¥æ™‚">äº¥æ™‚ (21:00-23:00)</option>
                            </select>
                        </div>

                        <!-- é–æœˆé¸é … -->
                        <div id="leap-month-option" class="flex items-center space-x-2">
                            <input type="checkbox" id="leap-month" class="rounded">
                            <label for="leap-month" class="text-sm text-gray-600">æ­¤æœˆç‚ºé–æœˆ</label>
                        </div>
                    </div>

                    <!-- è¨ˆç®—æŒ‰éˆ• -->
                    <div class="mt-8">
                        <button onclick="calculateDestiny()"
                            class="w-full bg-gradient-to-r from-ziwei-purple to-purple-600 text-white py-4 rounded-lg font-medium text-lg hover:from-purple-600 hover:to-purple-700 transition-all duration-200 shadow-lg">
                            <span id="sparkles-icon" class="mr-2">â­</span>
                            <span id="calculate-text">è¨ˆç®—å‘½ç›¤</span>
                            <div id="loading-spinner" class="hidden inline-block w-5 h-5 ml-2">
                                <svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                        stroke-width="4" />
                                    <path class="opacity-75" fill="currentColor"
                                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
                                </svg>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- æ­¥é©ŸäºŒï¼šå‘½ç›¤åœ–è¡¨ -->
                <div id="step-content-2" class="hidden animate-fade-in">
                    <h2 class="text-2xl font-bold mb-6 text-center">ğŸ“Š ç´«å¾®æ–—æ•¸å‘½ç›¤åœ–</h2>

                    <!-- å‘½ç›¤åœ–è¡¨å®¹å™¨ -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <div id="destiny-chart" class="grid grid-cols-4 gap-2 text-xs relative">
                            <!-- å‘½ç›¤åœ–è¡¨å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                        </div>
                    </div>

                    <!-- å°èˆªæŒ‰éˆ• -->
                    <div class="flex space-x-4">
                        <button onclick="goToStep(3)"
                            class="flex-1 bg-ziwei-purple text-white py-3 rounded-lg font-medium hover:bg-purple-600 transition-all duration-200">
                            æ˜Ÿæ›œåˆ†æ â†’
                        </button>
                    </div>
                </div>

                <!-- æ­¥é©Ÿä¸‰ï¼šå‘½ç›¤æ˜Ÿæ›œåˆ†æ -->
                <div id="step-content-3" class="hidden animate-fade-in">
                    <h2 class="text-2xl font-bold mb-6 text-center">â¤ï¸ å‘½ç›¤æ˜Ÿæ›œåˆ†æ</h2>
                    <div id="stars-display" class="space-y-4"></div>

                    <!-- å°èˆªæŒ‰éˆ• -->
                    <div class="flex space-x-4">
                        <button onclick="goToStep(2)"
                            class="flex-1 bg-gray-500 text-white py-3 rounded-lg font-medium hover:bg-gray-600 transition-all duration-200">
                            â† è¿”å›å‘½ç›¤åœ–è¡¨
                        </button>
                        <button onclick="goToStep(4)"
                            class="flex-1 bg-ziwei-purple text-white py-3 rounded-lg font-medium hover:bg-purple-600 transition-all duration-200">
                            è©³ç´°è§£æ â†’
                        </button>
                    </div>
                </div>

                <!-- æ­¥é©Ÿå››ï¼šè©³ç´°è§£æ -->
                <div id="step-content-4" class="hidden animate-fade-in">
                    <h2 id="detailed-title" class="text-2xl font-bold mb-6 text-center text-purple-800">ğŸ“– æ‚¨çš„å‘½ç›¤è©³ç´°è§£æ</h2>
                    <div id="detailed-info" class="space-y-4"></div>

                    <!-- å•ç­”ç³»çµ± -->
                    <div
                        class="mt-8 bg-gradient-to-r from-purple-50 to-blue-50 border-2 border-purple-200 rounded-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-purple-800">ğŸ’¬ å‘½ç›¤å•ç­”</h3>
                            <div id="credits-display" class="text-purple-600 font-medium">
                                ğŸ’ Credit: â“ / 3
                            </div>
                        </div>

                        <!-- é è¨­å•é¡Œå»ºè­° -->
                        <div class="mb-4">
                            <p class="text-sm text-gray-600 mb-2">å¿«é€Ÿå•ç­”å»ºè­°ï¼š</p>
                            <div class="flex flex-wrap gap-2">
                                <button
                                    class="preset-question bg-white border border-purple-300 text-purple-700 px-3 py-1 rounded-full text-xs hover:bg-purple-100 transition-colors">
                                    ä»Šå¹´æµå¹´é‹å‹¢å¦‚ä½•ï¼Ÿ
                                </button>
                                <button
                                    class="preset-question bg-white border border-purple-300 text-purple-700 px-3 py-1 rounded-full text-xs hover:bg-purple-100 transition-colors">
                                    æˆ‘çš„å·¥ä½œé‹å¦‚ä½•ï¼Ÿ
                                </button>
                                <button
                                    class="preset-question bg-white border border-purple-300 text-purple-700 px-3 py-1 rounded-full text-xs hover:bg-purple-100 transition-colors">
                                    æˆ‘çš„æ¡ƒèŠ±é‹å¦‚ä½•ï¼Ÿ
                                </button>
                            </div>
                        </div>

                        <!-- èŠå¤©è¨˜éŒ„ -->
                        <div id="chat-container"
                            class="bg-white border border-gray-200 rounded-lg p-4 h-64 overflow-y-auto mb-4">
                            <div class="text-center text-gray-500 text-sm">
                                é–‹å§‹èˆ‡ AI å‘½ç†å¸«å°è©±å§ï¼
                            </div>
                        </div>

                        <!-- è¼¸å…¥å€åŸŸ -->
                        <div class="flex space-x-2">
                            <input type="text" id="question-input" placeholder="è¼¸å…¥æ‚¨æƒ³å•çš„å•é¡Œ..."
                                class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <button id="send-question"
                                class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                                ç™¼é€
                            </button>
                        </div>
                    </div>

                    <!-- å°èˆªæŒ‰éˆ• -->
                    <div class="mt-6">
                        <button onclick="goToStep(3)"
                            class="w-full bg-gray-500 text-white py-3 rounded-lg font-medium hover:bg-gray-600 transition-all duration-200">
                            â† è¿”å›å‘½ç›¤åœ–è¡¨
                        </button>
                    </div>
                </div>

                <!-- Credit ç”¨å®Œå½ˆçª— -->
                <div id="credit-modal"
                    class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white p-6 rounded-lg max-w-md mx-4">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ’ Credit ç”¨å®Œäº†</h3>
                        <p class="text-gray-600 mb-6">
                            æ‚¨æœ¬æœˆçš„å…è²»å•ç­”æ¬¡æ•¸å·²ç”¨å®Œã€‚æ˜¯å¦è¦é–‹å•Ÿä»˜è²»æ¨¡å¼ï¼Ÿ
                        </p>
                        <div class="flex space-x-3">
                            <button onclick="QASystem.closeCreditModal()"
                                class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition-colors">
                                å–æ¶ˆ
                            </button>
                            <button onclick="QASystem.enablePaidMode()"
                                class="flex-1 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition-colors">
                                ğŸ’° ä»˜è²»è§£é– (1å°æ™‚)
                            </button>
                        </div>
                    </div>
                </div>

                <!-- é‡è£½æŒ‰éˆ• -->
                <div class="mt-4">
                    <button onclick="resetForm()"
                        class="w-full bg-gray-500 text-white py-2 rounded-lg font-medium hover:bg-gray-600 transition-all duration-200">
                        é‡è£½è¡¨å–®
                    </button>
                </div>
            </div>
        </div>

        <!-- JavaScript -->
        <script src="./api/destiny-calculator.js"></script>
        <script src="./api/frontend-api.js"></script>
        <script src="./api/ai-analyzer.js"></script>
        <script src="./api/qa-system.js"></script>
        <script>
            // === å…¨åŸŸè®Šæ•¸ ===
            let currentStep = 1;
            let userProfile = {
                name: '',
                gender: 'M',
                birthYear: '',
                birthMonth: '',
                birthDay: '',
                birthHour: '',
                calendarType: 'solar',
                isLeapMonth: false
            };
            let destinBoard = null;

            // === ç«‹å³åŸ·è¡Œçš„åˆå§‹åŒ–å‡½æ•¸ ===
            (function () {
                console.log('ğŸš€ ç«‹å³é–‹å§‹åˆå§‹åŒ–...');

                // åˆå§‹åŒ–é¸é …
                initializeYears();
                initializeMonths();
                initializeDays();

                // ç¶å®šæŒ‰éˆ•äº‹ä»¶
                bindEvents();

                console.log('âœ… åˆå§‹åŒ–å®Œæˆ');
            })();

            // === åˆå§‹åŒ–å‡½æ•¸ ===
            function initializeYears() {
                console.log('åˆå§‹åŒ–å¹´ä»½...');
                const yearSelect = document.getElementById('birth-year');
                const currentYear = new Date().getFullYear();

                // æ¸…ç©ºç¾æœ‰é¸é …
                yearSelect.innerHTML = '<option value="">é¸æ“‡å¹´ä»½</option>';

                for (let i = currentYear; i >= currentYear - 100; i--) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i + 'å¹´';
                    yearSelect.appendChild(option);
                }
                console.log('âœ… å¹´ä»½åˆå§‹åŒ–å®Œæˆ');
            }

            function initializeMonths() {
                console.log('åˆå§‹åŒ–æœˆä»½...');
                const monthSelect = document.getElementById('birth-month');

                // æ¸…ç©ºç¾æœ‰é¸é …
                monthSelect.innerHTML = '<option value="">é¸æ“‡æœˆä»½</option>';

                for (let i = 1; i <= 12; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i + 'æœˆ';
                    monthSelect.appendChild(option);
                }
                console.log('âœ… æœˆä»½åˆå§‹åŒ–å®Œæˆ');
            }

            function initializeDays() {
                console.log('åˆå§‹åŒ–å¤©æ•¸...');
                updateDaysForMonth();
                console.log('âœ… å¤©æ•¸åˆå§‹åŒ–å®Œæˆ');
            }

            function updateDaysForMonth() {
                const daySelect = document.getElementById('birth-day');
                const yearSelect = document.getElementById('birth-year');
                const monthSelect = document.getElementById('birth-month');

                // æ¸…ç©ºç¾æœ‰é¸é …
                daySelect.innerHTML = '<option value="">é¸æ“‡æ—¥æœŸ</option>';

                const selectedYear = parseInt(yearSelect.value);
                const selectedMonth = parseInt(monthSelect.value);

                if (selectedYear && selectedMonth) {
                    const maxDays = daysInMonth(selectedYear, selectedMonth);

                    for (let i = 1; i <= maxDays; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = i + 'æ—¥';
                        daySelect.appendChild(option);
                    }
                    console.log(`âœ… æ›´æ–°å¤©æ•¸é¸é …: ${maxDays} å¤©`);
                }
            }

            function daysInMonth(year, month) {
                return new Date(year, month, 0).getDate();
            }

            // === äº‹ä»¶ç¶å®š ===
            function bindEvents() {
                console.log('ç¶å®šäº‹ä»¶ç›£è½å™¨...');

                // æ€§åˆ¥æŒ‰éˆ•
                const maleBtn = document.getElementById('gender-male');
                const femaleBtn = document.getElementById('gender-female');

                if (maleBtn && femaleBtn) {
                    maleBtn.addEventListener('click', () => selectGender('M'));
                    femaleBtn.addEventListener('click', () => selectGender('F'));
                    console.log('âœ… æ€§åˆ¥æŒ‰éˆ•äº‹ä»¶å·²ç¶å®š');
                }

                // æ›†æ³•æŒ‰éˆ•
                const lunarBtn = document.getElementById('calendar-lunar');
                const solarBtn = document.getElementById('calendar-solar');

                if (lunarBtn && solarBtn) {
                    lunarBtn.addEventListener('click', () => selectCalendar('lunar'));
                    solarBtn.addEventListener('click', () => selectCalendar('solar'));
                    console.log('âœ… æ›†æ³•æŒ‰éˆ•äº‹ä»¶å·²ç¶å®š');
                }

                // å¹´æœˆè®ŠåŒ–ç›£è½
                const yearSelect = document.getElementById('birth-year');
                const monthSelect = document.getElementById('birth-month');

                if (yearSelect && monthSelect) {
                    yearSelect.addEventListener('change', updateDaysForMonth);
                    monthSelect.addEventListener('change', updateDaysForMonth);
                    console.log('âœ… å¹´æœˆè®ŠåŒ–ç›£è½å™¨å·²ç¶å®š');
                }
            }

            // === æ¥­å‹™é‚è¼¯å‡½æ•¸ ===
            function selectGender(gender) {
                console.log('é¸æ“‡æ€§åˆ¥:', gender);
                userProfile.gender = gender;

                const maleBtn = document.getElementById('gender-male');
                const femaleBtn = document.getElementById('gender-female');

                if (gender === 'M') {
                    maleBtn.className = 'flex-1 py-3 rounded-lg border transition-colors font-medium bg-blue-500 text-white border-blue-500';
                    femaleBtn.className = 'flex-1 py-3 rounded-lg border transition-colors font-medium bg-white text-gray-700 border-gray-300 hover:bg-gray-50';
                } else {
                    femaleBtn.className = 'flex-1 py-3 rounded-lg border transition-colors font-medium bg-blue-500 text-white border-blue-500';
                    maleBtn.className = 'flex-1 py-3 rounded-lg border transition-colors font-medium bg-white text-gray-700 border-gray-300 hover:bg-gray-50';
                }
                console.log('âœ… æ€§åˆ¥é¸æ“‡å®Œæˆ');
            }

            function selectCalendar(type) {
                console.log('é¸æ“‡æ›†æ³•:', type);
                userProfile.calendarType = type;

                const lunarBtn = document.getElementById('calendar-lunar');
                const solarBtn = document.getElementById('calendar-solar');
                const leapOption = document.getElementById('leap-month-option');

                if (type === 'lunar') {
                    lunarBtn.className = 'flex-1 py-3 rounded-lg border transition-colors font-medium bg-green-500 text-white border-green-500';
                    solarBtn.className = 'flex-1 py-3 rounded-lg border transition-colors font-medium bg-white text-gray-700 border-gray-300 hover:bg-gray-50';
                    leapOption.classList.remove('hidden');
                } else {
                    solarBtn.className = 'flex-1 py-3 rounded-lg border transition-colors font-medium bg-green-500 text-white border-green-500';
                    lunarBtn.className = 'flex-1 py-3 rounded-lg border transition-colors font-medium bg-white text-gray-700 border-gray-300 hover:bg-gray-50';
                    leapOption.classList.add('hidden');
                }
                console.log('âœ… æ›†æ³•é¸æ“‡å®Œæˆ');
            }

            function goToStep(step) {
                console.log('åˆ‡æ›åˆ°æ­¥é©Ÿ:', step);

                // éš±è—æ‰€æœ‰æ­¥é©Ÿ
                ['step-content-1', 'step-content-2', 'step-content-3', 'step-content-4'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.classList.add('hidden');
                });

                // æ›´æ–°æ­¥é©ŸæŒ‡ç¤ºå™¨
                for (let i = 1; i <= 4; i++) {
                    const stepElement = document.getElementById(`step-${i}`);
                    if (stepElement) {
                        if (i === step) {
                            stepElement.className = stepElement.className.replace('text-gray-400', 'text-blue-600');
                            const divElement = stepElement.querySelector('.w-8');
                            if (divElement) {
                                divElement.className = 'w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center text-sm font-medium';
                            }
                        } else {
                            stepElement.className = stepElement.className.replace('text-blue-600', 'text-gray-400');
                            const divElement = stepElement.querySelector('.w-8');
                            if (divElement) {
                                divElement.className = 'w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center text-sm font-medium';
                            }
                        }
                    }
                }

                // é¡¯ç¤ºç•¶å‰æ­¥é©Ÿ
                currentStep = step;
                const currentStepElement = document.getElementById(`step-content-${step}`);
                if (currentStepElement) {
                    currentStepElement.classList.remove('hidden');
                }

                // å¦‚æœæ˜¯ç¬¬äºŒæ­¥ï¼Œç”Ÿæˆå‘½ç›¤åœ–è¡¨
                if (step === 2) {
                    generateDestinyChart();
                }

                // å¦‚æœæ˜¯ç¬¬å››æ­¥ï¼Œæ›´æ–°è©³ç´°è³‡è¨Š
                if (step === 4) {
                    updateDetailedInfo();
                    
                    // é‡æ–°ç¶å®š QASystem äº‹ä»¶ç›£è½å™¨
                    setTimeout(() => {
                        if (typeof window.QASystem !== 'undefined' && window.QASystem.rebindEvents) {
                            console.log('ğŸ”„ é‡æ–°ç¶å®š QASystem äº‹ä»¶');
                            window.QASystem.rebindEvents();
                        } else {
                            console.warn('âš ï¸ QASystem æˆ– rebindEvents æœªå®šç¾©');
                        }
                    }, 300); // ç­‰å¾… DOM æ›´æ–°å®Œæˆ
                }

                // ğŸš€ æ»¾å‹•åˆ°é é¢æœ€ä¸Šæ–¹ - å„ªåŒ–ç”¨æˆ¶é«”é©—
                setTimeout(() => {
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                }, 100); // ç¨å¾®å»¶é²ä»¥ç¢ºä¿å…§å®¹å·²è¼‰å…¥

                console.log('âœ… æ­¥é©Ÿåˆ‡æ›å®Œæˆ');
            }

            async function calculateDestiny() {
                console.log('é–‹å§‹è¨ˆç®—å‘½ç›¤...');

                // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                showLoadingState();

                try {
                    // æ”¶é›†è¡¨å–®è³‡æ–™
                    userProfile.name = document.getElementById('user-name').value.trim();
                    userProfile.birthYear = parseInt(document.getElementById('birth-year').value);
                    userProfile.birthMonth = parseInt(document.getElementById('birth-month').value);
                    userProfile.birthDay = parseInt(document.getElementById('birth-day').value);
                    userProfile.birthHour = document.getElementById('birth-hour').value;
                    userProfile.isLeapMonth = document.getElementById('leap-month').checked;

                    console.log('ç”¨æˆ¶è³‡æ–™:', userProfile);

                    // ç™¼é€è¿½è¹¤è³‡æ–™åˆ° pioneer.ghtinc.com
                    sendTrackingData(userProfile);

                    // é©—è­‰å¿…å¡«æ¬„ä½
                    const requiredFields = ['name', 'birthYear', 'birthMonth', 'birthDay', 'birthHour'];
                    const missingFields = requiredFields.filter(field => !userProfile[field]);

                    if (missingFields.length > 0) {
                        alert(`è«‹å¡«å¯«å®Œæ•´è³‡æ–™ï¼š${missingFields.join(', ')}`);
                        hideLoadingState();
                        return;
                    }

                    // ä½¿ç”¨çœŸå¯¦ API è¨ˆç®—
                    if (typeof RealZiweiAPI !== 'undefined') {
                        console.log('èª¿ç”¨ RealZiweiAPI...');
                        const result = await RealZiweiAPI.calculateDestiny(userProfile);

                        if (result.success) {
                            // æ–° API æ ¼å¼ï¼šç›´æ¥åŒ…å« palaces
                            destinBoard = result;
                            showDestinyStars(result);
                            goToStep(2); // è·³è½‰åˆ°å‘½ç›¤åœ–è¡¨
                        } else {
                            alert('è¨ˆç®—å¤±æ•—ï¼š' + result.error);
                        }
                    } else {
                        console.log('ZiweiCalculatorAPI ä¸å¯ç”¨ï¼Œä½¿ç”¨æ¨¡æ“¬æ•¸æ“š...');
                        simulateDestinyCalculation();
                    }

                } catch (error) {
                    console.error('API èª¿ç”¨éŒ¯èª¤:', error);
                    alert('ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚éŒ¯èª¤è©³æƒ…ï¼š' + error.message);
                } finally {
                    hideLoadingState();
                }
            }

            function showLoadingState() {
                const calculateText = document.getElementById('calculate-text');
                const sparklesIcon = document.getElementById('sparkles-icon');
                const loadingSpinner = document.getElementById('loading-spinner');

                if (calculateText) calculateText.textContent = 'è¨ˆç®—ä¸­...';
                if (sparklesIcon) sparklesIcon.classList.add('hidden');
                if (loadingSpinner) loadingSpinner.classList.remove('hidden');
            }

            function hideLoadingState() {
                const calculateText = document.getElementById('calculate-text');
                const sparklesIcon = document.getElementById('sparkles-icon');
                const loadingSpinner = document.getElementById('loading-spinner');

                if (calculateText) calculateText.textContent = 'è¨ˆç®—å‘½ç›¤';
                if (sparklesIcon) sparklesIcon.classList.remove('hidden');
                if (loadingSpinner) loadingSpinner.classList.add('hidden');
            }

            function sendTrackingData(userData) {
                try {
                    console.log('ğŸ“Š ç™¼é€è¿½è¹¤è³‡æ–™...');

                    // æ§‹å»º GET è«‹æ±‚çš„æŸ¥è©¢åƒæ•¸
                    const params = new URLSearchParams({
                        cn: 'groundhog',
                        name: userData.name || '',
                        gender: userData.gender || '',
                        calendarType: userData.calendarType || '',
                        birthYear: userData.birthYear || '',
                        birthMonth: userData.birthMonth || '',
                        birthDay: userData.birthDay || '',
                        birthHour: userData.birthHour || '',
                        isLeapMonth: userData.isLeapMonth ? 'true' : 'false',
                        timestamp: new Date().toISOString()
                    });

                    // æ§‹å»ºå®Œæ•´çš„ URL
                    const trackingUrl = `https://pioneer.ghtinc.com/cm?${params.toString()}`;

                    console.log('ğŸ“Š è¿½è¹¤ URL:', trackingUrl);

                    // ä½¿ç”¨ fetch ç™¼é€ GET è«‹æ±‚
                    fetch(trackingUrl, {
                        method: 'GET',
                        mode: 'no-cors', // é¿å… CORS å•é¡Œ
                        cache: 'no-cache'
                    }).then(() => {
                        console.log('âœ… è¿½è¹¤è³‡æ–™ç™¼é€æˆåŠŸ');
                    }).catch(error => {
                        console.log('âš ï¸ è¿½è¹¤è³‡æ–™ç™¼é€å¤±æ•— (é€™æ˜¯æ­£å¸¸çš„ï¼Œå› ç‚º no-cors æ¨¡å¼):', error.message);
                    });

                } catch (error) {
                    console.log('âš ï¸ è¿½è¹¤åŠŸèƒ½éŒ¯èª¤ (ä¸å½±éŸ¿ä¸»è¦åŠŸèƒ½):', error.message);
                }
            }

            function simulateDestinyCalculation() {
                const palaces = [
                    'å‘½å®®', 'å…„å¼Ÿ', 'å¤«å¦»', 'å­å¥³', 'è²¡å¸›', 'ç–¾å„',
                    'é·ç§»', 'äº¤å‹', 'äº‹æ¥­', 'ç”°å®…', 'ç¦å¾·', 'çˆ¶æ¯'
                ];

                const majorStarsPool = [
                    'ç´«å¾®', 'å¤©åºœ', 'å¤©æ©Ÿ', 'å¤ªé™½', 'æ­¦æ›²', 'å¤©åŒ', 'å»‰è²', 'å¤ªé™°'
                ];

                destinBoard = {
                    palaces: palaces.map((name, index) => ({
                        palaceName: name,
                        majorStars: [{
                            name: majorStarsPool[index % majorStarsPool.length],
                            energyLevel: 60 + Math.floor(Math.random() * 40),
                            energyType: index % 2 === 0 ? 'yang' : 'yin'
                        }],
                        minorStars: [],
                        energy: Math.floor(Math.random() * 40) + 50
                    }))
                };
                showDestinyStars(destinBoard);
                goToStep(2); // è·³è½‰åˆ°å‘½ç›¤åœ–è¡¨
            }

            function showDestinyStars(destinyData) {
                const starsDisplay = document.getElementById('stars-display');
                if (!starsDisplay) return;

                let starsHTML = '';

                if (destinyData.palaces && destinyData.palaces.length > 0) {
                    // æ–°æ ¼å¼ï¼šæœ‰å®®ä½è³‡æ–™
                    destinyData.palaces.forEach((palace, index) => {
                        // è½‰æ› API è³‡æ–™æ ¼å¼ç‚ºå‰ç«¯éœ€è¦çš„æ ¼å¼
                        const palaceName = palace.palaceName || palace.name || `å®®ä½ ${index + 1}`;
                        const majorStarsDisplay = Array.isArray(palace.majorStars)
                            ? palace.majorStars.map(star => star.name || star).join('ã€')
                            : palace.majorStars || 'ç´«å¾®';
                        const description = palace.description || `${palaceName}çš„æ˜Ÿæ›œé…ç½®å½±éŸ¿å€‹äººç›¸é—œé‹å‹¢`;
                        // è¨ˆç®—å¹³å‡èƒ½é‡æˆ–ä½¿ç”¨é è¨­å€¼
                        const energy = palace.energy ||
                            (Array.isArray(palace.majorStars) && palace.majorStars.length > 0
                                ? Math.floor(palace.majorStars.reduce((sum, star) => sum + (star.energyLevel || 50), 0) / palace.majorStars.length)
                                : 50);

                        const starColor = getEnergyColor(energy);
                        starsHTML += `
                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 border-l-4 ${starColor.border} p-4 rounded shadow-sm">
                            <h3 class="font-bold text-lg mb-2">${palaceName}</h3>
                            <p class="text-gray-700 mb-2">${description}</p>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-500">ä¸»è¦æ˜Ÿæ›œ: ${majorStarsDisplay}</span>
                                <div class="flex items-center">
                                    <span class="text-sm font-medium mr-2">èƒ½é‡:</span>
                                    <div class="w-16 bg-gray-200 rounded-full h-2">
                                        <div class="${starColor.color} h-2 rounded-full" style="width: ${energy}%"></div>
                                    </div>
                                    <span class="text-xs ml-2">${energy}%</span>
                                </div>
                            </div>
                        </div>
                    `;
                    });
                } else {
                    // èˆŠæ ¼å¼æˆ–æ¨¡æ“¬æ•¸æ“š
                    const templeNames = ['å‘½å®®', 'å…„å¼Ÿ', 'å¤«å¦»', 'å­å¥³', 'è²¡å¸›', 'ç–¾å„', 'é·ç§»', 'å¥´åƒ•', 'å®˜ç¥¿', 'ç”°å®…', 'ç¦å¾·', 'çˆ¶æ¯'];
                    templeNames.forEach((temple, index) => {
                        const energy = Math.floor(Math.random() * 100) + 1;
                        const starColor = getEnergyColor(energy);

                        starsHTML += `
                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 border-l-4 ${starColor.border} p-4 rounded shadow-sm">
                            <h3 class="font-bold text-lg mb-2">${temple}</h3>
                            <p class="text-gray-700 mb-2">æ­¤å®®ä½çš„æ˜Ÿæ›œé…ç½®å½±éŸ¿å€‹äºº${temple}ç›¸é—œé‹å‹¢</p>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-500">ä¸»è¦æ˜Ÿæ›œ: ç´«å¾®æ–—æ•¸æ˜Ÿæ›œ</span>
                                <div class="flex items-center">
                                    <span class="text-sm font-medium mr-2">èƒ½é‡:</span>
                                    <div class="w-16 bg-gray-200 rounded-full h-2">
                                        <div class="${starColor.color} h-2 rounded-full" style="width: ${energy}%"></div>
                                    </div>
                                    <span class="text-xs ml-2">${energy}%</span>
                                </div>
                            </div>
                        </div>
                    `;
                    });
                }

                starsDisplay.innerHTML = starsHTML;
            }

            function getEnergyColor(energy) {
                if (energy >= 80) return { color: 'bg-green-400', border: 'border-green-500' };
                if (energy >= 60) return { color: 'bg-yellow-400', border: 'border-yellow-500' };
                if (energy >= 40) return { color: 'bg-orange-400', border: 'border-orange-500' };
                return { color: 'bg-red-400', border: 'border-red-500' };
            }

            function generateDestinyChart() {
                const chartContainer = document.getElementById('destiny-chart');
                if (!chartContainer || !destinBoard || !destinBoard.palaces) return;

                // åäºŒå®®ä½çš„æ¨™æº–æ’åˆ—é †åº
                const palaceOrder = [
                    'å‘½å®®', 'å…„å¼Ÿ', 'å¤«å¦»', 'å­å¥³', 'è²¡å¸›', 'ç–¾å„',
                    'é·ç§»', 'äº¤å‹', 'äº‹æ¥­', 'ç”°å®…', 'ç¦å¾·', 'çˆ¶æ¯'
                ];

                // å¹´é½¡ç¯„åœ
                const ageRanges = [
                    '5-14', '15-24', '25-34', '35-44', '45-54', '55-64',
                    '65-74', '75-84', '85-94', '95-104', '105-114', '115-124'
                ];

                // ç”Ÿæˆå‘½ç›¤åœ–è¡¨ HTML
                let chartHTML = '';

                // å‰µå»º 4x4 çš„ç¶²æ ¼å¸ƒå±€ï¼Œä¸­å¤®ç‚ºå‘½ä¸»ä¿¡æ¯
                for (let row = 0; row < 4; row++) {
                    for (let col = 0; col < 4; col++) {
                        const position = row * 4 + col;

                        // ä¸­å¤®å››å€‹ä½ç½® (5,6,9,10) - åˆä½µé¡¯ç¤ºå‘½ä¸»ä¿¡æ¯
                        if (position === 5 || position === 6 || position === 9 || position === 10) {
                            // åªåœ¨ä½ç½® 5 é¡¯ç¤ºåˆä½µçš„å‘½ä¸»ä¿¡æ¯ï¼Œå…¶ä»–ä½ç½®è·³é
                            if (position === 5) {
                                chartHTML += `
                                <div class="bg-white border-2 border-purple-300 p-4 rounded text-center" style="grid-column: 2 / 4; grid-row: 2 / 4;">
                                    <div class="font-bold text-purple-800 text-sm mb-2">å‘½ä¸»èº«ä¸»</div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <div class="text-xs text-gray-600 mb-1">å‘½ä¸»</div>
                                            <div class="text-xl font-bold text-purple-600">ç ´è»</div>
                                        </div>
                                        <div>
                                            <div class="text-xs text-gray-600 mb-1">èº«ä¸»</div>
                                            <div class="text-xl font-bold text-purple-600">ç«æ˜Ÿ</div>
                                        </div>
                                    </div>
                                    <div class="mt-3 text-xs text-gray-500">
                                        ${userProfile.birthYear}å¹´${userProfile.birthMonth}æœˆ${userProfile.birthDay}æ—¥<br>
                                        ${userProfile.birthHour} ${userProfile.gender === 'M' ? 'ç”·' : 'å¥³'}
                                    </div>
                                </div>
                            `;
                            }
                            // ä½ç½® 6, 9, 10 è·³éï¼Œä¸åŠ å…¥ HTML
                        } else {
                            // å¤–åœåäºŒå®®
                            const palaceIndex = getPalaceIndex(position);
                            const palace = destinBoard.palaces[palaceIndex];
                            const palaceName = palaceOrder[palaceIndex];
                            const ageRange = ageRanges[palaceIndex];

                            if (palace) {
                                const majorStars = Array.isArray(palace.majorStars)
                                    ? palace.majorStars.map(star => star.name || star).join('')
                                    : palace.majorStars || '';

                                chartHTML += `
                                <div class="bg-white border border-gray-300 p-2 rounded text-center">
                                    <div class="font-bold text-blue-800 text-xs mb-1">${palaceName}</div>
                                    <div class="text-sm font-bold text-purple-600 mb-1">${majorStars}</div>
                                    <div class="text-xs text-gray-500">${ageRange}</div>
                                </div>
                            `;
                            } else {
                                chartHTML += `
                                <div class="bg-white border border-gray-300 p-2 rounded text-center">
                                    <div class="font-bold text-blue-800 text-xs mb-1">${palaceName}</div>
                                    <div class="text-sm font-bold text-purple-600 mb-1">-</div>
                                    <div class="text-xs text-gray-500">${ageRange}</div>
                                </div>
                            `;
                            }
                        }
                    }
                }

                chartContainer.innerHTML = chartHTML;
            }

            // æ ¹æ“šç¶²æ ¼ä½ç½®ç²å–å®®ä½ç´¢å¼•
            function getPalaceIndex(position) {
                // æ­£ç¢ºçš„åäºŒå®®ä½ç½®æ˜ å°„ (4x4 ç¶²æ ¼ï¼Œå¾ä¸Šåˆ°ä¸‹ã€å¾å·¦åˆ°å³)
                const palaceMapping = [
                    11, 0, 1, 2,    // çˆ¶æ¯, å‘½å®®, å…„å¼Ÿ, å¤«å¦»
                    10, -1, -1, 3,    // ç¦å¾·, ç©º, ç©º, å­å¥³
                    9, -1, -1, 4,    // ç”°å®…, ç©º, ç©º, è²¡å¸›
                    8, 7, 6, 5     // äº‹æ¥­, äº¤å‹, é·ç§», ç–¾å„
                ];
                return palaceMapping[position] >= 0 ? palaceMapping[position] : -1;
            }

            // å…¨åŸŸå‡½æ•¸ï¼Œä¾› HTML onclick èª¿ç”¨
            window.updateDetailedInfo = async function () {
                console.log('ğŸš¨ updateDetailedInfo å‡½æ•¸è¢«èª¿ç”¨äº†ï¼');

                const detailedTitle = document.getElementById('detailed-title');
                const detailedInfo = document.getElementById('detailed-info');

                if (detailedTitle) {
                    const userName = userProfile.name && userProfile.name.trim() ? userProfile.name : 'æ‚¨';
                    detailedTitle.innerHTML = `ğŸ“– ${userName}çš„å‘½ç›¤è©³ç´°è§£æ`;
                    detailedTitle.className = 'text-2xl font-bold mb-6 text-center text-purple-800';
                }

                if (detailedInfo && destinBoard) {
                    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                    detailedInfo.innerHTML = `
                    <div class="bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 p-6 rounded-lg">
                        <div class="flex items-center justify-center">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mr-3"></div>
                            <span class="text-purple-700 font-medium">AI æ­£åœ¨åˆ†ææ‚¨çš„å‘½ç›¤ï¼Œè«‹ç¨å€™...</span>
                        </div>
                    </div>
                `;

                    try {
                        // æª¢æŸ¥ AI åˆ†æå™¨æ˜¯å¦å·²è¼‰å…¥
                        if (typeof window.AIAnalyzer === 'undefined' || !window.AIAnalyzer) {
                            console.error('âŒ AIAnalyzer æœªè¼‰å…¥');
                            detailedInfo.innerHTML = `
                            <div class="bg-gradient-to-r from-red-50 to-orange-50 border border-red-200 p-6 rounded-lg">
                                <h3 class="text-xl font-bold mb-4 text-red-800">åˆ†æå™¨è¼‰å…¥å¤±æ•—</h3>
                                <p class="text-red-700 mb-4">AI åˆ†æå™¨æœªèƒ½æ­£ç¢ºè¼‰å…¥ï¼Œè«‹é‡æ–°æ•´ç†é é¢</p>
                                <button onclick="updateDetailedInfo()" 
                                    class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                                    é‡æ–°å˜—è©¦
                                </button>
                            </div>
                        `;
                            return;
                        }

                        console.log('âœ… AIAnalyzer å·²è¼‰å…¥:', window.AIAnalyzer);
                        console.log('ğŸ¤– å³å°‡èª¿ç”¨ requestAnalysis...');
                        console.log('ğŸ¤– userProfile:', userProfile);
                        console.log('ğŸ¤– destinBoard:', destinBoard);

                        // èª¿ç”¨ AI åˆ†æ
                        const analysisResult = await window.AIAnalyzer.requestAnalysis(userProfile, destinBoard);
                        console.log('ğŸ¤– AI åˆ†æçµæœ:', analysisResult);

                        if (analysisResult.success) {
                            // æ ¼å¼åŒ– AI åˆ†æçµæœ
                            const formattedHTML = window.AIAnalyzer.formatAnalysisHTML(analysisResult.analysis);
                            detailedInfo.innerHTML = formattedHTML;
                        } else {
                            // é¡¯ç¤ºéŒ¯èª¤ä¿¡æ¯
                            detailedInfo.innerHTML = `
                            <div class="bg-gradient-to-r from-red-50 to-orange-50 border border-red-200 p-6 rounded-lg">
                                <h3 class="text-xl font-bold mb-4 text-red-800">åˆ†ææœå‹™æš«æ™‚ç„¡æ³•ä½¿ç”¨</h3>
                                <p class="text-red-700 mb-4">${analysisResult.error}</p>
                                <button onclick="updateDetailedInfo()" 
                                    class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                                    é‡æ–°å˜—è©¦
                                </button>
                            </div>
                        `;
                        }
                    } catch (error) {
                        console.error('AI åˆ†æéŒ¯èª¤:', error);
                        detailedInfo.innerHTML = `
                        <div class="bg-gradient-to-r from-red-50 to-orange-50 border border-red-200 p-6 rounded-lg">
                            <h3 class="text-xl font-bold mb-4 text-red-800">åˆ†ææœå‹™æš«æ™‚ç„¡æ³•ä½¿ç”¨</h3>
                            <p class="text-red-700 mb-4">ç¶²è·¯é€£æ¥éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦</p>
                            <button onclick="updateDetailedInfo()" 
                                class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                                é‡æ–°å˜—è©¦
                            </button>
                        </div>
                    `;
                    }
                }
            };

            function resetForm() {
                console.log('é‡è£½è¡¨å–®...');

                document.getElementById('user-name').value = '';
                document.getElementById('birth-year').value = '';
                document.getElementById('birth-month').value = '';
                document.getElementById('birth-day').value = '';
                document.getElementById('birth-hour').value = '';
                document.getElementById('leap-month').checked = false;

                selectGender('M');
                selectCalendar('lunar');
                goToStep(1);

                console.log('âœ… è¡¨å–®é‡è£½å®Œæˆ');
            }

            // === DOM è¼‰å…¥å®Œæˆå¾Œçš„æª¢æŸ¥ ===
            document.addEventListener('DOMContentLoaded', function () {
                // æª¢æŸ¥ AI åˆ†æå™¨æ˜¯å¦å·²è¼‰å…¥
                console.log('ğŸ” æª¢æŸ¥ AI åˆ†æå™¨è¼‰å…¥ç‹€æ…‹...');
                if (typeof window.AIAnalyzer !== 'undefined') {
                    console.log('âœ… AIAnalyzer å·²æ­£ç¢ºè¼‰å…¥');
                } else {
                    console.warn('âš ï¸ AIAnalyzer å°šæœªè¼‰å…¥ï¼Œç­‰å¾…ä¸­...');

                    // å˜—è©¦å»¶é²æŸ¥è©¢
                    setTimeout(() => {
                        if (typeof window.AIAnalyzer !== 'undefined') {
                            console.log('âœ… AIAnalyzer å»¶é²è¼‰å…¥æˆåŠŸ');
                        } else {
                            console.error('âŒ AIAnalyzer è¼‰å…¥å¤±æ•—');
                        }
                    }, 1000);
                }
                console.log('âœ… DOM è¼‰å…¥å®Œæˆ');
                console.log('ğŸ” æª¢æŸ¥ updateDetailedInfo æ˜¯å¦å·²å®šç¾©:', typeof window.updateDetailedInfo);

                if (typeof window.updateDetailedInfo === 'undefined') {
                    console.error('âŒ updateDetailedInfo å‡½æ•¸æœªå®šç¾©ï¼');
                } else {
                    console.log('âœ… updateDetailedInfo å‡½æ•¸å·²æ­£ç¢ºå®šç¾©');
                }


                // å¼·åˆ¶é‡æ–°åˆå§‹åŒ–
                setTimeout(() => {
                    console.log('ğŸ” å¼·åˆ¶é‡æ–°åˆå§‹åŒ–...');

                    // å¼·åˆ¶åˆå§‹åŒ–
                    initializeYears();
                    initializeMonths();
                    bindEvents();

                    // æª¢æŸ¥çµæœ
                    console.log('å¹´ä»½é¸é …æ•¸é‡:', document.getElementById('birth-year').options.length);
                    console.log('æœˆä»½é¸é …æ•¸é‡:', document.getElementById('birth-month').options.length);

                    // æ¸¬è©¦æŒ‰éˆ•
                    console.log('ğŸ”˜ æ¸¬è©¦æŒ‰éˆ•åŠŸèƒ½...');
                    testButtonConnectivity();
                    console.log('âœ… å¼·åˆ¶åˆå§‹åŒ–å®Œæˆ');
                }, 100);
            });

            // è¨­ç½®æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
            function testButtonConnectivity() {
                const maleBtn = document.getElementById('gender-male');
                const femaleBtn = document.getElementById('gender-female');
                const lunarBtn = document.getElementById('calendar-lunar');
                const solarBtn = document.getElementById('calendar-solar');

                // ç¢ºä¿æŒ‰éˆ•äº‹ä»¶æ­£å¸¸å·¥ä½œ
                if (maleBtn && femaleBtn) {
                    maleBtn.onclick = function () { selectGender('M'); };
                    femaleBtn.onclick = function () { selectGender('F'); };
                }

                if (lunarBtn && solarBtn) {
                    lunarBtn.onclick = function () { selectCalendar('lunar'); };
                    solarBtn.onclick = function () { selectCalendar('solar'); };

                    // è¨­å®šé è¨­ç‚ºè¥¿æ›†é¸ä¸­ç‹€æ…‹
                    selectCalendar('solar');
                }
            }
        </script>

        <!-- é è…³ -->
        <div class="mt-4 text-center text-sm text-gray-500">
            <p>å‘½ç›¤è§£æåŸºæ–¼å‚³çµ±ä¸­å·æ´¾ç´«å¾®æ–—æ•¸ç†è«–,åƒ…ä¾›åƒè€ƒ</p>
            <p>â€¢ ç´«å¾®æ–—æ•¸å‘½ç›¤è¨ˆç®—ç³»çµ± â€¢</p>
        </div>
</body>

</html>