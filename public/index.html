<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç´«å¾®æ–—æ•¸å‘½ç›¤ - ä¿®å¾©ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ziwei: {
                            purple: '#9333ea',
                            gold: '#f59e0b',
                            blue: '#3b82f6',
                            green: '#10b981'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loading-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="min-h-screen bg-gray-100">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-2xl bg-white rounded-xl shadow-lg p-6">
            <!-- æ¨™é¡Œ -->
            <div class="flex items-center justify-center mb-6">
                <svg class="w-6 h-6 mr-2 text-ziwei-purple" fill="currentColor" viewBox="0 0 24 24">
                    <path
                        d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                </svg>
                <h1 class="text-3xl font-bold text-center">ç´«å¾®æ–—æ•¸å‘½ç›¤</h1>
            </div>

            <p class="text-center text-gray-600 mb-8">éµå¾ªä¸­å·æ´¾å‚³çµ±ç†è«– Â· ä¸»é æ•´åˆç‰ˆæœ¬</p>

            <!-- æ­¥é©ŸæŒ‡ç¤ºå™¨ -->
            <div class="flex justify-center mb-8 space-x-8">
                <div id="step-1" class="flex items-center">
                    <div
                        class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center text-sm font-medium">
                        1</div>
                    <span class="ml-2 text-blue-600 font-medium">åŸºæœ¬è³‡æ–™</span>
                </div>
                <div id="step-2" class="flex items-center">
                    <div
                        class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center text-sm font-medium">
                        2</div>
                    <span class="ml-2 text-gray-400 font-medium">å‘½ç›¤æ˜Ÿæ›œ</span>
                </div>
                <div id="step-3" class="flex items-center">
                    <div
                        class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center text-sm font-medium">
                        3</div>
                    <span class="ml-2 text-gray-400 font-medium">è©³ç´°è§£æ</span>
                </div>
            </div>

            <!-- æ­¥é©Ÿä¸€ï¼šåŸºæœ¬è³‡æ–™è¼¸å…¥ -->
            <div id="step-content-1" class="animate-fade-in">
                <h2 class="text-2xl font-bold mb-6 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-blue-500" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M9 16.171l9.594-9.594L17.172 5.84 11.5 11.512 6.828 6.84 5.406 8.264 11.5 14.358z" />
                    </svg>
                    å€‹äººåŸºæœ¬è³‡æ–™
                </h2>

                <div class="space-y-6">
                    <!-- å§“åå’Œæ€§åˆ¥ -->
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-2 font-medium">å§“å</label>
                            <input type="text" id="user-name"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                                placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å" />
                        </div>

                        <div>
                            <label class="block mb-2 font-medium">æ€§åˆ¥</label>
                            <div class="flex space-x-2">
                                <button id="gender-male"
                                    class="flex-1 py-3 rounded-lg border transition-colors font-medium bg-blue-500 text-white border-blue-500">
                                    ç”·
                                </button>
                                <button id="gender-female"
                                    class="flex-1 py-3 rounded-lg border transition-colors font-medium bg-white text-gray-700 border-gray-300 hover:bg-gray-50">
                                    å¥³
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- æ›†æ³•é¡å‹ -->
                    <div>
                        <label class="block mb-2 font-medium">æ›†æ³•é¡å‹</label>
                        <div class="flex space-x-2">
                            <button id="calendar-lunar"
                                class="flex-1 py-3 rounded-lg border transition-colors font-medium bg-green-500 text-white border-green-500">
                                è¾²æ›†
                            </button>
                            <button id="calendar-solar"
                                class="flex-1 py-3 rounded-lg border transition-colors font-medium bg-white text-gray-700 border-gray-300 hover:bg-gray-50">
                                è¥¿æ›†
                            </button>
                        </div>
                    </div>

                    <!-- å‡ºç”Ÿæ—¥æœŸ -->
                    <div class="grid md:grid-cols-3 gap-4">
                        <div>
                            <label class="block mb-2 font-medium">å‡ºç”Ÿå¹´</label>
                            <select id="birth-year"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">é¸æ“‡å¹´ä»½</option>
                            </select>
                        </div>

                        <div>
                            <label class="block mb-2 font-medium">å‡ºç”Ÿæœˆ</label>
                            <select id="birth-month"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">é¸æ“‡æœˆä»½</option>
                            </select>
                        </div>

                        <div>
                            <label class="block mb-2 font-medium">å‡ºç”Ÿæ—¥</label>
                            <select id="birth-day"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">é¸æ“‡æ—¥æœŸ</option>
                            </select>
                        </div>
                    </div>

                    <!-- å‡ºç”Ÿæ™‚è¾° -->
                    <div>
                        <label class="block mb-2 font-medium flex items-center">
                            <svg class="w-4 h-4 mr-1 text-gray-500" fill="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z" />
                                <polyline points="12,6 12,12 16,14" />
                            </svg>
                            å‡ºç”Ÿæ™‚è¾°
                        </label>
                        <select id="birth-hour"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">é¸æ“‡æ™‚è¾°</option>
                            <option value="å­æ™‚">å­æ™‚ (23:00-01:00)</option>
                            <option value="ä¸‘æ™‚">ä¸‘æ™‚ (01:00-03:00)</option>
                            <option value="å¯…æ™‚">å¯…æ™‚ (03:00-05:00)</option>
                            <option value="å¯æ™‚">å¯æ™‚ (05:00-07:00)</option>
                            <option value="è¾°æ™‚">è¾°æ™‚ (07:00-09:00)</option>
                            <option value="å·³æ™‚">å·³æ™‚ (09:00-11:00)</option>
                            <option value="åˆæ™‚">åˆæ™‚ (11:00-13:00)</option>
                            <option value="æœªæ™‚">æœªæ™‚ (13:00-15:00)</option>
                            <option value="ç”³æ™‚">ç”³æ™‚ (15:00-17:00)</option>
                            <option value="é…‰æ™‚">é…‰æ™‚ (17:00-19:00)</option>
                            <option value="æˆŒæ™‚">æˆŒæ™‚ (19:00-21:00)</option>
                            <option value="äº¥æ™‚">äº¥æ™‚ (21:00-23:00)</option>
                        </select>
                    </div>

                    <!-- é–æœˆé¸é … -->
                    <div id="leap-month-option" class="flex items-center space-x-2">
                        <input type="checkbox" id="leap-month" class="rounded">
                        <label for="leap-month" class="text-sm text-gray-600">æ­¤æœˆç‚ºé–æœˆ</label>
                    </div>
                </div>

                <!-- è¨ˆç®—æŒ‰éˆ• -->
                <div class="mt-8">
                    <button onclick="calculateDestiny()"
                        class="w-full bg-gradient-to-r from-ziwei-purple to-purple-600 text-white py-4 rounded-lg font-medium text-lg hover:from-purple-600 hover:to-purple-700 transition-all duration-200 shadow-lg">
                        <span id="sparkles-icon" class="mr-2">â­</span>
                        <span id="calculate-text">è¨ˆç®—å‘½ç›¤</span>
                        <div id="loading-spinner" class="hidden inline-block w-5 h-5 ml-2">
                            <svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4" />
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
                            </svg>
                        </div>
                    </button>
                </div>
            </div>

            <!-- æ­¥é©ŸäºŒï¼šæ¨™é¡Œè¡Œæ˜Ÿæ›œé¡¯ç¤º - éš±è— -->
            <div id="step-content-2" class="hidden animate-fade-in">
                <h2 class="text-2xl font-bold mb-6 text-center">â¤ï¸ å‘½ç›¤æ˜Ÿæ›œåˆ†æ</h2>
                <div id="stars-display" class="space-y-4"></div>
            </div>

            <!-- æ­¥é©Ÿä¸‰ï¼šè©³ç´°è§£æ - éš±è— -->
            <div id="step-content-3" class="hidden animate-fade-in">
                <h2 id="detailed-title" class="text-2xl font-bold mb-6 text-center"></h2>
                <div id="detailed-info" class="space-y-4"></div>
            </div>

            <!-- é‡è£½æŒ‰éˆ• -->
            <div class="mt-4">
                <button onclick="resetForm()"
                    class="w-full bg-gray-500 text-white py-2 rounded-lg font-medium hover:bg-gray-600 transition-all duration-200">
                    é‡è£½è¡¨å–®
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="./api/destiny-calculator.js"></script>
    <script src="./api/frontend-api.js"></script>
    <script>
        // === å…¨åŸŸè®Šæ•¸ ===
        let currentStep = 1;
        let userProfile = {
            name: '',
            gender: 'M',
            birthYear: '',
            birthMonth: '',
            birthDay: '',
            birthHour: '',
            calendarType: 'lunar',
            isLeapMonth: false
        };
        let destinBoard = null;

        // === ç«‹å³åŸ·è¡Œçš„åˆå§‹åŒ–å‡½æ•¸ ===
        (function () {
            console.log('ğŸš€ ç«‹å³é–‹å§‹åˆå§‹åŒ–...');

            // åˆå§‹åŒ–é¸é …
            initializeYears();
            initializeMonths();
            initializeDays();

            // ç¶å®šæŒ‰éˆ•äº‹ä»¶
            bindEvents();

            console.log('âœ… åˆå§‹åŒ–å®Œæˆ');
        })();

        // === åˆå§‹åŒ–å‡½æ•¸ ===
        function initializeYears() {
            console.log('åˆå§‹åŒ–å¹´ä»½...');
            const yearSelect = document.getElementById('birth-year');
            const currentYear = new Date().getFullYear();

            // æ¸…ç©ºç¾æœ‰é¸é …
            yearSelect.innerHTML = '<option value="">é¸æ“‡å¹´ä»½</option>';

            for (let i = currentYear - 100; i <= currentYear; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i + 'å¹´';
                yearSelect.appendChild(option);
            }
            console.log('âœ… å¹´ä»½åˆå§‹åŒ–å®Œæˆ');
        }

        function initializeMonths() {
            console.log('åˆå§‹åŒ–æœˆä»½...');
            const monthSelect = document.getElementById('birth-month');

            // æ¸…ç©ºç¾æœ‰é¸é …
            monthSelect.innerHTML = '<option value="">é¸æ“‡æœˆä»½</option>';

            for (let i = 1; i <= 12; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i + 'æœˆ';
                monthSelect.appendChild(option);
            }
            console.log('âœ… æœˆä»½åˆå§‹åŒ–å®Œæˆ');
        }

        function initializeDays() {
            console.log('åˆå§‹åŒ–å¤©æ•¸...');
            updateDaysForMonth();
            console.log('âœ… å¤©æ•¸åˆå§‹åŒ–å®Œæˆ');
        }

        function updateDaysForMonth() {
            const daySelect = document.getElementById('birth-day');
            const yearSelect = document.getElementById('birth-year');
            const monthSelect = document.getElementById('birth-month');

            // æ¸…ç©ºç¾æœ‰é¸é …
            daySelect.innerHTML = '<option value="">é¸æ“‡æ—¥æœŸ</option>';

            const selectedYear = parseInt(yearSelect.value);
            const selectedMonth = parseInt(monthSelect.value);

            if (selectedYear && selectedMonth) {
                const maxDays = daysInMonth(selectedYear, selectedMonth);

                for (let i = 1; i <= maxDays; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i + 'æ—¥';
                    daySelect.appendChild(option);
                }
                console.log(`âœ… æ›´æ–°å¤©æ•¸é¸é …: ${maxDays} å¤©`);
            }
        }

        function daysInMonth(year, month) {
            return new Date(year, month, 0).getDate();
        }

        // === äº‹ä»¶ç¶å®š ===
        function bindEvents() {
            console.log('ç¶å®šäº‹ä»¶ç›£è½å™¨...');

            // æ€§åˆ¥æŒ‰éˆ•
            const maleBtn = document.getElementById('gender-male');
            const femaleBtn = document.getElementById('gender-female');

            if (maleBtn && femaleBtn) {
                maleBtn.addEventListener('click', () => selectGender('M'));
                femaleBtn.addEventListener('click', () => selectGender('F'));
                console.log('âœ… æ€§åˆ¥æŒ‰éˆ•äº‹ä»¶å·²ç¶å®š');
            }

            // æ›†æ³•æŒ‰éˆ•
            const lunarBtn = document.getElementById('calendar-lunar');
            const solarBtn = document.getElementById('calendar-solar');

            if (lunarBtn && solarBtn) {
                lunarBtn.addEventListener('click', () => selectCalendar('lunar'));
                solarBtn.addEventListener('click', () => selectCalendar('solar'));
                console.log('âœ… æ›†æ³•æŒ‰éˆ•äº‹ä»¶å·²ç¶å®š');
            }

            // å¹´æœˆè®ŠåŒ–ç›£è½
            const yearSelect = document.getElementById('birth-year');
            const monthSelect = document.getElementById('birth-month');

            if (yearSelect && monthSelect) {
                yearSelect.addEventListener('change', updateDaysForMonth);
                monthSelect.addEventListener('change', updateDaysForMonth);
                console.log('âœ… å¹´æœˆè®ŠåŒ–ç›£è½å™¨å·²ç¶å®š');
            }
        }

        // === æ¥­å‹™é‚è¼¯å‡½æ•¸ ===
        function selectGender(gender) {
            console.log('é¸æ“‡æ€§åˆ¥:', gender);
            userProfile.gender = gender;

            const maleBtn = document.getElementById('gender-male');
            const femaleBtn = document.getElementById('gender-female');

            if (gender === 'M') {
                maleBtn.className = 'flex-1 py-3 rounded-lg border transition-colors font-medium bg-blue-500 text-white border-blue-500';
                femaleBtn.className = 'flex-1 py-3 rounded-lg border transition-colors font-medium bg-white text-gray-700 border-gray-300 hover:bg-gray-50';
            } else {
                femaleBtn.className = 'flex-1 py-3 rounded-lg border transition-colors font-medium bg-blue-500 text-white border-blue-500';
                maleBtn.className = 'flex-1 py-3 rounded-lg border transition-colors font-medium bg-white text-gray-700 border-gray-300 hover:bg-gray-50';
            }
            console.log('âœ… æ€§åˆ¥é¸æ“‡å®Œæˆ');
        }

        function selectCalendar(type) {
            console.log('é¸æ“‡æ›†æ³•:', type);
            userProfile.calendarType = type;

            const lunarBtn = document.getElementById('calendar-lunar');
            const solarBtn = document.getElementById('calendar-solar');
            const leapOption = document.getElementById('leap-month-option');

            if (type === 'lunar') {
                lunarBtn.className = 'flex-1 py-3 rounded-lg border transition-colors font-medium bg-green-500 text-white border-green-500';
                solarBtn.className = 'flex-1 py-3 rounded-lg border transition-colors font-medium bg-white text-gray-700 border-gray-300 hover:bg-gray-50';
                leapOption.classList.remove('hidden');
            } else {
                solarBtn.className = 'flex-1 py-3 rounded-lg border transition-colors font-medium bg-green-500 text-white border-green-500';
                lunarBtn.className = 'flex-1 py-3 rounded-lg border transition-colors font-medium bg-white text-gray-700 border-gray-300 hover:bg-gray-50';
                leapOption.classList.add('hidden');
            }
            console.log('âœ… æ›†æ³•é¸æ“‡å®Œæˆ');
        }

        function goToStep(step) {
            console.log('åˆ‡æ›åˆ°æ­¥é©Ÿ:', step);

            // éš±è—æ‰€æœ‰æ­¥é©Ÿ
            ['step-content-1', 'step-content-2', 'step-content-3'].forEach(id => {
                const element = document.getElementById(id);
                if (element) element.classList.add('hidden');
            });

            // æ›´æ–°æ­¥é©ŸæŒ‡ç¤ºå™¨
            for (let i = 1; i <= 3; i++) {
                const stepElement = document.getElementById(`step-${i}`);
                if (stepElement) {
                    if (i === step) {
                        stepElement.className = stepElement.className.replace('text-gray-400', 'text-blue-600');
                        const divElement = stepElement.querySelector('.w-8');
                        if (divElement) {
                            divElement.className = 'w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center text-sm font-medium';
                        }
                    } else {
                        stepElement.className = stepElement.className.replace('text-blue-600', 'text-gray-400');
                        const divElement = stepElement.querySelector('.w-8');
                        if (divElement) {
                            divElement.className = 'w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center text-sm font-medium';
                        }
                    }
                }
            }

            // é¡¯ç¤ºç•¶å‰æ­¥é©Ÿ
            currentStep = step;
            const currentStepElement = document.getElementById(`step-content-${step}`);
            if (currentStepElement) {
                currentStepElement.classList.remove('hidden');
            }

            // å¦‚æœæ˜¯ç¬¬ä¸‰æ­¥ï¼Œæ›´æ–°è©³ç´°è³‡è¨Š
            if (step === 3) {
                updateDetailedInfo();
            }

            console.log('âœ… æ­¥é©Ÿåˆ‡æ›å®Œæˆ');
        }

        async function calculateDestiny() {
            console.log('é–‹å§‹è¨ˆç®—å‘½ç›¤...');

            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            showLoadingState();

            try {
                // æ”¶é›†è¡¨å–®è³‡æ–™
                userProfile.name = document.getElementById('user-name').value.trim();
                userProfile.birthYear = parseInt(document.getElementById('birth-year').value);
                userProfile.birthMonth = parseInt(document.getElementById('birth-month').value);
                userProfile.birthDay = parseInt(document.getElementById('birth-day').value);
                userProfile.birthHour = document.getElementById('birth-hour').value;
                userProfile.isLeapMonth = document.getElementById('leap-month').checked;

                console.log('ç”¨æˆ¶è³‡æ–™:', userProfile);

                // é©—è­‰å¿…å¡«æ¬„ä½
                const requiredFields = ['name', 'birthYear', 'birthMonth', 'birthDay', 'birthHour'];
                const missingFields = requiredFields.filter(field => !userProfile[field]);

                if (missingFields.length > 0) {
                    alert(`è«‹å¡«å¯«å®Œæ•´è³‡æ–™ï¼š${missingFields.join(', ')}`);
                    hideLoadingState();
                    return;
                }

                // ä½¿ç”¨çœŸå¯¦ API è¨ˆç®—
                if (typeof RealZiweiAPI !== 'undefined') {
                    console.log('èª¿ç”¨ RealZiweiAPI...');
                    const result = await RealZiweiAPI.calculateDestiny(userProfile);

                    if (result.success) {
                        destinBoard = result.destinyInfo;
                        showDestinyStars(result.destinyInfo);
                        goToStep(2);
                    } else {
                        alert('è¨ˆç®—å¤±æ•—ï¼š' + result.error);
                    }
                } else {
                    console.log('ZiweiCalculatorAPI ä¸å¯ç”¨ï¼Œä½¿ç”¨æ¨¡æ“¬æ•¸æ“š...');
                    simulateDestinyCalculation();
                }

            } catch (error) {
                console.error('API èª¿ç”¨éŒ¯èª¤:', error);
                alert('ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚éŒ¯èª¤è©³æƒ…ï¼š' + error.message);
            } finally {
                hideLoadingState();
            }
        }

        function showLoadingState() {
            const calculateText = document.getElementById('calculate-text');
            const sparklesIcon = document.getElementById('sparkles-icon');
            const loadingSpinner = document.getElementById('loading-spinner');

            if (calculateText) calculateText.textContent = 'è¨ˆç®—ä¸­...';
            if (sparklesIcon) sparklesIcon.classList.add('hidden');
            if (loadingSpinner) loadingSpinner.classList.remove('hidden');
        }

        function hideLoadingState() {
            const calculateText = document.getElementById('calculate-text');
            const sparklesIcon = document.getElementById('sparkles-icon');
            const loadingSpinner = document.getElementById('loading-spinner');

            if (calculateText) calculateText.textContent = 'è¨ˆç®—å‘½ç›¤';
            if (sparklesIcon) sparklesIcon.classList.remove('hidden');
            if (loadingSpinner) loadingSpinner.classList.add('hidden');
        }

        function simulateDestinyCalculation() {
            destinBoard = {
                mainStar: 'ç´«å¾®æ˜Ÿ',
                temples: ['å‘½å®®', 'å…„å¼Ÿ', 'å¤«å¦»', 'å­å¥³', 'è²¡å¸›', 'ç–¾å„', 'é·ç§»', 'å¥´åƒ•', 'å®˜ç¥¿', 'ç”°å®…', 'ç¦å¾·', 'çˆ¶æ¯'],
                energy: Math.floor(Math.random() * 100) + 1
            };
            showDestinyStars(destinBoard);
            goToStep(2);
        }

        function showDestinyStars(destinyData) {
            const starsDisplay = document.getElementById('stars-display');
            if (!starsDisplay) return;

            let starsHTML = '';

            if (destinyData.palaces && destinyData.palaces.length > 0) {
                // æ–°æ ¼å¼ï¼šæœ‰å®®ä½è³‡æ–™
                destinyData.palaces.forEach((palace, index) => {
                    // è½‰æ› API è³‡æ–™æ ¼å¼ç‚ºå‰ç«¯éœ€è¦çš„æ ¼å¼
                    const palaceName = palace.palaceName || palace.name || `å®®ä½ ${index + 1}`;
                    const majorStarsDisplay = Array.isArray(palace.majorStars)
                        ? palace.majorStars.map(star => star.name || star).join('ã€')
                        : palace.majorStars || 'ç´«å¾®';
                    const description = palace.description || `${palaceName}çš„æ˜Ÿæ›œé…ç½®å½±éŸ¿å€‹äººç›¸é—œé‹å‹¢`;
                    // è¨ˆç®—å¹³å‡èƒ½é‡æˆ–ä½¿ç”¨é è¨­å€¼
                    const energy = palace.energy ||
                        (Array.isArray(palace.majorStars) && palace.majorStars.length > 0
                            ? Math.floor(palace.majorStars.reduce((sum, star) => sum + (star.energyLevel || 50), 0) / palace.majorStars.length)
                            : 50);

                    const starColor = getEnergyColor(energy);
                    starsHTML += `
                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 border-l-4 ${starColor.border} p-4 rounded shadow-sm">
                            <h3 class="font-bold text-lg mb-2">${palaceName}</h3>
                            <p class="text-gray-700 mb-2">${description}</p>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-500">ä¸»è¦æ˜Ÿæ›œ: ${majorStarsDisplay}</span>
                                <div class="flex items-center">
                                    <span class="text-sm font-medium mr-2">èƒ½é‡:</span>
                                    <div class="w-16 bg-gray-200 rounded-full h-2">
                                        <div class="${starColor.color} h-2 rounded-full" style="width: ${energy}%"></div>
                                    </div>
                                    <span class="text-xs ml-2">${energy}%</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                // èˆŠæ ¼å¼æˆ–æ¨¡æ“¬æ•¸æ“š
                const templeNames = ['å‘½å®®', 'å…„å¼Ÿ', 'å¤«å¦»', 'å­å¥³', 'è²¡å¸›', 'ç–¾å„', 'é·ç§»', 'å¥´åƒ•', 'å®˜ç¥¿', 'ç”°å®…', 'ç¦å¾·', 'çˆ¶æ¯'];
                templeNames.forEach((temple, index) => {
                    const energy = Math.floor(Math.random() * 100) + 1;
                    const starColor = getEnergyColor(energy);

                    starsHTML += `
                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 border-l-4 ${starColor.border} p-4 rounded shadow-sm">
                            <h3 class="font-bold text-lg mb-2">${temple}</h3>
                            <p class="text-gray-700 mb-2">æ­¤å®®ä½çš„æ˜Ÿæ›œé…ç½®å½±éŸ¿å€‹äºº${temple}ç›¸é—œé‹å‹¢</p>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-500">ä¸»è¦æ˜Ÿæ›œ: ç´«å¾®æ–—æ•¸æ˜Ÿæ›œ</span>
                                <div class="flex items-center">
                                    <span class="text-sm font-medium mr-2">èƒ½é‡:</span>
                                    <div class="w-16 bg-gray-200 rounded-full h-2">
                                        <div class="${starColor.color} h-2 rounded-full" style="width: ${energy}%"></div>
                                    </div>
                                    <span class="text-xs ml-2">${energy}%</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            starsDisplay.innerHTML = starsHTML;
        }

        function getEnergyColor(energy) {
            if (energy >= 80) return { color: 'bg-green-400', border: 'border-green-500' };
            if (energy >= 60) return { color: 'bg-yellow-400', border: 'border-yellow-500' };
            if (energy >= 40) return { color: 'bg-orange-400', border: 'border-orange-500' };
            return { color: 'bg-red-400', border: 'border-red-500' };
        }

        function updateDetailedInfo() {
            const detailedTitle = document.getElementById('detailed-title');
            const detailedInfo = document.getElementById('detailed-info');

            if (detailedTitle) detailedTitle.textContent = `${userProfile.name}çš„å‘½ç›¤è©³ç´°è§£æ`;

            if (detailedInfo && destinBoard) {
                detailedInfo.innerHTML = `
                    <div class="bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 p-6 rounded-lg">
                        <h3 class="text-xl font-bold mb-4 text-purple-800">å‘½ç›¤ç¸½çµ</h3>
                        <div class="space-y-3">
                            <p><strong>å§“å:</strong> ${userProfile.name}</p>
                            <p><strong>æ€§åˆ¥:</strong> ${userProfile.gender === 'M' ? 'ç”·æ€§' : 'å¥³æ€§'}</p>
                            <p><strong>å‡ºç”Ÿæ—¥æœŸ:</strong> ${userProfile.birthYear}å¹´${userProfile.birthMonth}æœˆ${userProfile.birthDay}æ—¥</p>
                            <p><strong>å‡ºç”Ÿæ™‚è¾°:</strong> ${userProfile.birthHour}</p>
                            <p><strong>æ›†æ³•é¡å‹:</strong> ${userProfile.calendarType === 'lunar' ? 'è¾²æ›†' : 'è¥¿æ›†'}</p>
                            ${userProfile.isLeapMonth ? '<p><strong>é–æœˆ:</strong> æ˜¯</p>' : ''}
                        </div>
                        <div class="mt-4 p-4 bg-white rounded border">
                            <p class="text-gray-700 text-center">
                                åŸºæ–¼å‚³çµ±ä¸­å·æ´¾ç´«å¾®æ–—æ•¸ç†è«–ï¼Œæ­¤å‘½ç›¤å±•ç¾æ‚¨çš„æ€§æ ¼ç‰¹è³ªã€é‹å‹¢èµ°å‘èˆ‡äººç”Ÿç™¼å±•è¦å¾‹ã€‚
                                æ¯å€‹å®®ä½éƒ½æœ‰å…¶ç¨ç‰¹çš„æ˜Ÿæ›œé…ç½®ï¼Œå½±éŸ¿è‘—ä¸åŒç”Ÿæ´»é¢åŸŸçš„ç™¼å±•ã€‚
                            </p>
                        </div>
                    </div>
                `;
            }

            goToStep(3);
        }

        function resetForm() {
            console.log('é‡è£½è¡¨å–®...');

            document.getElementById('user-name').value = '';
            document.getElementById('birth-year').value = '';
            document.getElementById('birth-month').value = '';
            document.getElementById('birth-day').value = '';
            document.getElementById('birth-hour').value = '';
            document.getElementById('leap-month').checked = false;

            selectGender('M');
            selectCalendar('lunar');
            goToStep(1);

            console.log('âœ… è¡¨å–®é‡è£½å®Œæˆ');
        }

        // === DOM è¼‰å…¥å®Œæˆå¾Œçš„æª¢æŸ¥ ===
        document.addEventListener('DOMContentLoaded', function () {
            console.log('âœ… DOM è¼‰å…¥å®Œæˆ');

            // å¼·åˆ¶é‡æ–°åˆå§‹åŒ–
            setTimeout(() => {
                console.log('ğŸ” å¼·åˆ¶é‡æ–°åˆå§‹åŒ–...');

                // å¼·åˆ¶åˆå§‹åŒ–
                initializeYears();
                initializeMonths();
                bindEvents();

                // æª¢æŸ¥çµæœ
                console.log('å¹´ä»½é¸é …æ•¸é‡:', document.getElementById('birth-year').options.length);
                console.log('æœˆä»½é¸é …æ•¸é‡:', document.getElementById('birth-month').options.length);

                // æ¸¬è©¦æŒ‰éˆ•
                console.log('ğŸ”˜ æ¸¬è©¦æŒ‰éˆ•åŠŸèƒ½...');
                testButtonConnectivity();
                console.log('âœ… å¼·åˆ¶åˆå§‹åŒ–å®Œæˆ');
            }, 100);
        });

        // è¨­ç½®æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
        function testButtonConnectivity() {
            const maleBtn = document.getElementById('gender-male');
            const femaleBtn = document.getElementById('gender-female');
            const lunarBtn = document.getElementById('calendar-lunar');
            const solarBtn = document.getElementById('calendar-solar');

            // ç¢ºä¿æŒ‰éˆ•äº‹ä»¶æ­£å¸¸å·¥ä½œ
            if (maleBtn && femaleBtn) {
                maleBtn.onclick = function () { selectGender('M'); };
                femaleBtn.onclick = function () { selectGender('F'); };
            }

            if (lunarBtn && solarBtn) {
                lunarBtn.onclick = function () { selectCalendar('lunar'); };
                solarBtn.onclick = function () { selectCalendar('solar'); };
            }
        }
    </script>

    <!-- é è…³ -->
    <div class="mt-4 text-center text-sm text-gray-500">
        <p>å‘½ç›¤è§£æåŸºæ–¼å‚³çµ±ä¸­å·æ´¾ç´«å¾®æ–—æ•¸ç†è«–,åƒ…ä¾›åƒè€ƒ</p>
        <p>Copyright (c) 2022 Airic Yu | Maintained by iTubai</p>
        <p>â€¢ ç´«å¾®æ–—æ•¸å‘½ç›¤è¨ˆç®—ç³»çµ± â€¢</p>
    </div>
</body>

</html>