<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>問答 API 測試工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-purple-600">問答 API 測試工具</h1>

        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-bold mb-4">步驟 1: 測試數據準備</h2>

            <div class="mb-4">
                <label class="block font-bold mb-2">用戶資料 (userProfile)</label>
                <textarea id="userProfile" class="w-full p-3 border rounded h-32 font-mono text-sm">
{
  "name": "測試用戶",
  "gender": "M",
  "birthYear": 1990,
  "birthMonth": 5,
  "birthDay": 15,
  "birthHour": "午時",
  "calendarType": "solar",
  "isLeapMonth": false
}
                </textarea>
            </div>

            <div class="mb-4">
                <label class="block font-bold mb-2">命盤資料 (destinyData)</label>
                <textarea id="destinyData" class="w-full p-3 border rounded h-64 font-mono text-sm">
{
  "palaces": [
    {
      "palaceName": "命宮",
      "majorStars": [
        {"name": "紫微", "energyLevel": 80}
      ]
    },
    {
      "palaceName": "兄弟宮",
      "majorStars": [
        {"name": "天機", "energyLevel": 60}
      ]
    },
    {
      "palaceName": "夫妻宮",
      "majorStars": []
    },
    {
      "palaceName": "子女宮",
      "majorStars": []
    },
    {
      "palaceName": "財帛宮",
      "majorStars": []
    },
    {
      "palaceName": "疾厄宮",
      "majorStars": []
    },
    {
      "palaceName": "遷移宮",
      "majorStars": []
    },
    {
      "palaceName": "交友宮",
      "majorStars": []
    },
    {
      "palaceName": "事業宮",
      "majorStars": []
    },
    {
      "palaceName": "田宅宮",
      "majorStars": []
    },
    {
      "palaceName": "福德宮",
      "majorStars": []
    },
    {
      "palaceName": "父母宮",
      "majorStars": []
    }
  ]
}
                </textarea>
            </div>

            <div class="mb-4">
                <label class="block font-bold mb-2">問題 (question)</label>
                <input type="text" id="question" value="今年流年運勢如何？" class="w-full p-3 border rounded">
            </div>

            <button onclick="testQuestionAPI()" class="bg-purple-600 text-white px-6 py-3 rounded hover:bg-purple-700">
                🧪 測試問答 API
            </button>

            <button onclick="testFromWindow()" class="bg-blue-600 text-white px-6 py-3 rounded hover:bg-blue-700 ml-2">
                🔍 使用 Window 數據測試
            </button>

            <button onclick="copyWindowData()"
                class="bg-green-600 text-white px-6 py-3 rounded hover:bg-green-700 ml-2">
                📋 複製 Window 數據
            </button>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-bold mb-4">步驟 2: 請求信息</h2>
            <pre id="requestInfo" class="bg-gray-100 p-4 rounded overflow-auto text-xs"></pre>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-bold mb-4">步驟 3: 回應結果</h2>
            <pre id="responseInfo" class="bg-gray-100 p-4 rounded overflow-auto text-xs"></pre>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-bold mb-4">步驟 4: Window 數據診斷</h2>
            <div id="windowDiagnosis" class="text-sm"></div>
            <button onclick="diagnoseWindow()"
                class="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700 mt-4">
                🔍 診斷 Window 數據
            </button>
        </div>
    </div>

    <script>
        function diagnoseWindow() {
            const diagnosis = document.getElementById('windowDiagnosis');

            let html = '<div class="space-y-4">';

            // 檢查 userProfile
            html += '<div class="border-l-4 border-blue-500 pl-4">';
            html += '<h3 class="font-bold">window.userProfile:</h3>';
            if (typeof window.userProfile !== 'undefined') {
                html += '<pre class="bg-gray-100 p-2 rounded mt-2 text-xs overflow-auto">' +
                    JSON.stringify(window.userProfile, null, 2) + '</pre>';
            } else {
                html += '<p class="text-red-600">❌ 未定義</p>';
            }
            html += '</div>';

            // 檢查 destinBoard
            html += '<div class="border-l-4 border-purple-500 pl-4">';
            html += '<h3 class="font-bold">window.destinBoard:</h3>';
            if (typeof window.destinBoard !== 'undefined') {
                const info = {
                    exists: true,
                    isNull: window.destinBoard === null,
                    type: typeof window.destinBoard,
                    hasPalaces: !!(window.destinBoard && window.destinBoard.palaces),
                    palacesType: window.destinBoard && typeof window.destinBoard.palaces,
                    palacesLength: window.destinBoard && window.destinBoard.palaces ? window.destinBoard.palaces.length : 0,
                    keys: window.destinBoard ? Object.keys(window.destinBoard) : []
                };
                html += '<pre class="bg-gray-100 p-2 rounded mt-2 text-xs overflow-auto">' +
                    JSON.stringify(info, null, 2) + '</pre>';

                if (window.destinBoard && window.destinBoard.palaces) {
                    html += '<details class="mt-2"><summary class="cursor-pointer text-blue-600">查看完整數據</summary>';
                    html += '<pre class="bg-gray-100 p-2 rounded mt-2 text-xs overflow-auto">' +
                        JSON.stringify(window.destinBoard, null, 2) + '</pre>';
                    html += '</details>';
                }
            } else {
                html += '<p class="text-red-600">❌ 未定義</p>';
            }
            html += '</div>';

            html += '</div>';
            diagnosis.innerHTML = html;
        }

        function copyWindowData() {
            if (!window.destinBoard || !window.userProfile) {
                alert('請先在主頁面計算命盤');
                return;
            }

            document.getElementById('userProfile').value = JSON.stringify(window.userProfile, null, 2);
            document.getElementById('destinyData').value = JSON.stringify(window.destinBoard, null, 2);
            alert('✅ 已複製 Window 數據到表單');
        }

        async function testFromWindow() {
            if (!window.destinBoard || !window.userProfile) {
                alert('請先在主頁面計算命盤，或使用左側的測試數據');
                return;
            }

            const question = document.getElementById('question').value;

            await sendRequest({
                question: question,
                userProfile: window.userProfile,
                destinyData: window.destinBoard,
                userId: 'test_' + Date.now()
            });
        }

        async function testQuestionAPI() {
            try {
                const userProfile = JSON.parse(document.getElementById('userProfile').value);
                const destinyData = JSON.parse(document.getElementById('destinyData').value);
                const question = document.getElementById('question').value;

                await sendRequest({
                    question: question,
                    userProfile: userProfile,
                    destinyData: destinyData,
                    userId: 'test_' + Date.now()
                });
            } catch (error) {
                alert('JSON 解析錯誤：' + error.message);
            }
        }

        async function sendRequest(requestData) {
            const requestInfo = document.getElementById('requestInfo');
            const responseInfo = document.getElementById('responseInfo');

            // 顯示請求信息
            requestInfo.textContent = '📤 發送請求中...\n\n' +
                JSON.stringify({
                    url: '/api/question',
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': requestData.userId
                    },
                    body: {
                        ...requestData,
                        destinyData: {
                            ...requestData.destinyData,
                            palaces: `[${requestData.destinyData.palaces?.length || 0} palaces]`
                        }
                    }
                }, null, 2);

            try {
                const response = await fetch('/api/question', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': requestData.userId
                    },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();

                // 顯示回應
                responseInfo.textContent =
                    `📥 回應狀態: ${response.status} ${response.statusText}\n\n` +
                    `結果:\n${JSON.stringify(result, null, 2)}`;

                if (response.ok) {
                    responseInfo.className = 'bg-green-50 p-4 rounded overflow-auto text-xs border border-green-200';
                } else {
                    responseInfo.className = 'bg-red-50 p-4 rounded overflow-auto text-xs border border-red-200';
                }

            } catch (error) {
                responseInfo.textContent = '❌ 錯誤: ' + error.message + '\n\n' + error.stack;
                responseInfo.className = 'bg-red-50 p-4 rounded overflow-auto text-xs border border-red-200';
            }
        }

        // 頁面載入時診斷
        window.addEventListener('load', () => {
            diagnoseWindow();
        });
    </script>
</body>

</html>