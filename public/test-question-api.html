<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•ç­” API æ¸¬è©¦å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-purple-600">å•ç­” API æ¸¬è©¦å·¥å…·</h1>

        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-bold mb-4">æ­¥é©Ÿ 1: æ¸¬è©¦æ•¸æ“šæº–å‚™</h2>

            <div class="mb-4">
                <label class="block font-bold mb-2">ç”¨æˆ¶è³‡æ–™ (userProfile)</label>
                <textarea id="userProfile" class="w-full p-3 border rounded h-32 font-mono text-sm">
{
  "name": "æ¸¬è©¦ç”¨æˆ¶",
  "gender": "M",
  "birthYear": 1990,
  "birthMonth": 5,
  "birthDay": 15,
  "birthHour": "åˆæ™‚",
  "calendarType": "solar",
  "isLeapMonth": false
}
                </textarea>
            </div>

            <div class="mb-4">
                <label class="block font-bold mb-2">å‘½ç›¤è³‡æ–™ (destinyData)</label>
                <textarea id="destinyData" class="w-full p-3 border rounded h-64 font-mono text-sm">
{
  "palaces": [
    {
      "palaceName": "å‘½å®®",
      "majorStars": [
        {"name": "ç´«å¾®", "energyLevel": 80}
      ]
    },
    {
      "palaceName": "å…„å¼Ÿå®®",
      "majorStars": [
        {"name": "å¤©æ©Ÿ", "energyLevel": 60}
      ]
    },
    {
      "palaceName": "å¤«å¦»å®®",
      "majorStars": []
    },
    {
      "palaceName": "å­å¥³å®®",
      "majorStars": []
    },
    {
      "palaceName": "è²¡å¸›å®®",
      "majorStars": []
    },
    {
      "palaceName": "ç–¾å„å®®",
      "majorStars": []
    },
    {
      "palaceName": "é·ç§»å®®",
      "majorStars": []
    },
    {
      "palaceName": "äº¤å‹å®®",
      "majorStars": []
    },
    {
      "palaceName": "äº‹æ¥­å®®",
      "majorStars": []
    },
    {
      "palaceName": "ç”°å®…å®®",
      "majorStars": []
    },
    {
      "palaceName": "ç¦å¾·å®®",
      "majorStars": []
    },
    {
      "palaceName": "çˆ¶æ¯å®®",
      "majorStars": []
    }
  ]
}
                </textarea>
            </div>

            <div class="mb-4">
                <label class="block font-bold mb-2">å•é¡Œ (question)</label>
                <input type="text" id="question" value="ä»Šå¹´æµå¹´é‹å‹¢å¦‚ä½•ï¼Ÿ" class="w-full p-3 border rounded">
            </div>

            <button onclick="testQuestionAPI()" class="bg-purple-600 text-white px-6 py-3 rounded hover:bg-purple-700">
                ğŸ§ª æ¸¬è©¦å•ç­” API
            </button>

            <button onclick="testFromWindow()" class="bg-blue-600 text-white px-6 py-3 rounded hover:bg-blue-700 ml-2">
                ğŸ” ä½¿ç”¨ Window æ•¸æ“šæ¸¬è©¦
            </button>

            <button onclick="copyWindowData()"
                class="bg-green-600 text-white px-6 py-3 rounded hover:bg-green-700 ml-2">
                ğŸ“‹ è¤‡è£½ Window æ•¸æ“š
            </button>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-bold mb-4">æ­¥é©Ÿ 2: è«‹æ±‚ä¿¡æ¯</h2>
            <pre id="requestInfo" class="bg-gray-100 p-4 rounded overflow-auto text-xs"></pre>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-bold mb-4">æ­¥é©Ÿ 3: å›æ‡‰çµæœ</h2>
            <pre id="responseInfo" class="bg-gray-100 p-4 rounded overflow-auto text-xs"></pre>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-bold mb-4">æ­¥é©Ÿ 4: Window æ•¸æ“šè¨ºæ–·</h2>
            <div id="windowDiagnosis" class="text-sm"></div>
            <button onclick="diagnoseWindow()"
                class="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700 mt-4">
                ğŸ” è¨ºæ–· Window æ•¸æ“š
            </button>
        </div>
    </div>

    <script>
        function diagnoseWindow() {
            const diagnosis = document.getElementById('windowDiagnosis');

            let html = '<div class="space-y-4">';

            // æª¢æŸ¥ userProfile
            html += '<div class="border-l-4 border-blue-500 pl-4">';
            html += '<h3 class="font-bold">window.userProfile:</h3>';
            if (typeof window.userProfile !== 'undefined') {
                html += '<pre class="bg-gray-100 p-2 rounded mt-2 text-xs overflow-auto">' +
                    JSON.stringify(window.userProfile, null, 2) + '</pre>';
            } else {
                html += '<p class="text-red-600">âŒ æœªå®šç¾©</p>';
            }
            html += '</div>';

            // æª¢æŸ¥ destinBoard
            html += '<div class="border-l-4 border-purple-500 pl-4">';
            html += '<h3 class="font-bold">window.destinBoard:</h3>';
            if (typeof window.destinBoard !== 'undefined') {
                const info = {
                    exists: true,
                    isNull: window.destinBoard === null,
                    type: typeof window.destinBoard,
                    hasPalaces: !!(window.destinBoard && window.destinBoard.palaces),
                    palacesType: window.destinBoard && typeof window.destinBoard.palaces,
                    palacesLength: window.destinBoard && window.destinBoard.palaces ? window.destinBoard.palaces.length : 0,
                    keys: window.destinBoard ? Object.keys(window.destinBoard) : []
                };
                html += '<pre class="bg-gray-100 p-2 rounded mt-2 text-xs overflow-auto">' +
                    JSON.stringify(info, null, 2) + '</pre>';

                if (window.destinBoard && window.destinBoard.palaces) {
                    html += '<details class="mt-2"><summary class="cursor-pointer text-blue-600">æŸ¥çœ‹å®Œæ•´æ•¸æ“š</summary>';
                    html += '<pre class="bg-gray-100 p-2 rounded mt-2 text-xs overflow-auto">' +
                        JSON.stringify(window.destinBoard, null, 2) + '</pre>';
                    html += '</details>';
                }
            } else {
                html += '<p class="text-red-600">âŒ æœªå®šç¾©</p>';
            }
            html += '</div>';

            html += '</div>';
            diagnosis.innerHTML = html;
        }

        function copyWindowData() {
            if (!window.destinBoard || !window.userProfile) {
                alert('è«‹å…ˆåœ¨ä¸»é é¢è¨ˆç®—å‘½ç›¤');
                return;
            }

            document.getElementById('userProfile').value = JSON.stringify(window.userProfile, null, 2);
            document.getElementById('destinyData').value = JSON.stringify(window.destinBoard, null, 2);
            alert('âœ… å·²è¤‡è£½ Window æ•¸æ“šåˆ°è¡¨å–®');
        }

        async function testFromWindow() {
            if (!window.destinBoard || !window.userProfile) {
                alert('è«‹å…ˆåœ¨ä¸»é é¢è¨ˆç®—å‘½ç›¤ï¼Œæˆ–ä½¿ç”¨å·¦å´çš„æ¸¬è©¦æ•¸æ“š');
                return;
            }

            const question = document.getElementById('question').value;

            await sendRequest({
                question: question,
                userProfile: window.userProfile,
                destinyData: window.destinBoard,
                userId: 'test_' + Date.now()
            });
        }

        async function testQuestionAPI() {
            try {
                const userProfile = JSON.parse(document.getElementById('userProfile').value);
                const destinyData = JSON.parse(document.getElementById('destinyData').value);
                const question = document.getElementById('question').value;

                await sendRequest({
                    question: question,
                    userProfile: userProfile,
                    destinyData: destinyData,
                    userId: 'test_' + Date.now()
                });
            } catch (error) {
                alert('JSON è§£æéŒ¯èª¤ï¼š' + error.message);
            }
        }

        async function sendRequest(requestData) {
            const requestInfo = document.getElementById('requestInfo');
            const responseInfo = document.getElementById('responseInfo');

            // é¡¯ç¤ºè«‹æ±‚ä¿¡æ¯
            requestInfo.textContent = 'ğŸ“¤ ç™¼é€è«‹æ±‚ä¸­...\n\n' +
                JSON.stringify({
                    url: '/api/question',
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': requestData.userId
                    },
                    body: {
                        ...requestData,
                        destinyData: {
                            ...requestData.destinyData,
                            palaces: `[${requestData.destinyData.palaces?.length || 0} palaces]`
                        }
                    }
                }, null, 2);

            try {
                const response = await fetch('/api/question', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': requestData.userId
                    },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();

                // é¡¯ç¤ºå›æ‡‰
                responseInfo.textContent =
                    `ğŸ“¥ å›æ‡‰ç‹€æ…‹: ${response.status} ${response.statusText}\n\n` +
                    `çµæœ:\n${JSON.stringify(result, null, 2)}`;

                if (response.ok) {
                    responseInfo.className = 'bg-green-50 p-4 rounded overflow-auto text-xs border border-green-200';
                } else {
                    responseInfo.className = 'bg-red-50 p-4 rounded overflow-auto text-xs border border-red-200';
                }

            } catch (error) {
                responseInfo.textContent = 'âŒ éŒ¯èª¤: ' + error.message + '\n\n' + error.stack;
                responseInfo.className = 'bg-red-50 p-4 rounded overflow-auto text-xs border border-red-200';
            }
        }

        // é é¢è¼‰å…¥æ™‚è¨ºæ–·
        window.addEventListener('load', () => {
            diagnoseWindow();
        });
    </script>
</body>

</html>