<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>瀏覽器端到端測試</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .test-running {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .test-pass {
            background: #d4edda;
            color: #155724;
        }

        .test-fail {
            background: #f8d7da;
            color: #721c24;
        }

        .test-warn {
            background: #fff3cd;
            color: #856404;
        }
    </style>
</head>

<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-3xl font-bold text-blue-600 mb-6">🔬 紫微斗數系統端到端測試</h1>

            <!-- 測試控制 -->
            <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                <h2 class="text-xl font-bold mb-4">測試控制台</h2>
                <div class="flex space-x-4">
                    <button onclick="runAllTests()"
                        class="bg-green-500 text-white px-6 py-2 rounded hover:bg-green-600 transition-colors">
                        🚀 執行全部測試
                    </button>
                    <button onclick="testButtons()"
                        class="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600 transition-colors">
                        🔘 測試按鈕功能
                    </button>
                    <button onclick="testFormValidation()"
                        class="bg-purple-500 text-white px-6 py-2 rounded hover:bg-purple-600 transition-colors">
                        📝 測試表單驗證
                    </button>
                    <button onclick="testCalculation()"
                        class="bg-orange-500 text-white px-6 py-2 rounded hover:bg-orange-600 transition-colors">
                        ⚙️ 測試計算功能
                    </button>
                </div>
            </div>

            <!-- 測試結果區域 -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h2 class="text-xl font-bold mb-4">測試結果</h2>
                <div id="test-results" class="space-y-2">
                    <div class="text-gray-500">點擊上方按鈕開始測試...</div>
                </div>

                <!-- 測試統計 -->
                <div id="test-summary" class="mt-6 p-4 bg-white rounded border" style="display: none;">
                    <h3 class="font-bold mb-2">📊 測試統計</h3>
                    <div class="grid grid-cols-4 gap-4 text-sm">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-gray-600" id="total-tests">0</div>
                            <div class="text-xs">總測試數</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600" id="passed-tests">0</div>
                            <div class="text-xs">通過</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-red-600" id="failed-tests">0</div>
                            <div class="text-xs">失敗</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-yellow-600" id="warning-tests">0</div>
                            <div class="text-xs">警告</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 即時主頁預覽 -->
            <div class="mt-8 p-4 bg-gray-50 rounded-lg">
                <h3 class="text-lg font-bold mb-4">📱 主頁即時檢測</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gaps-4">
                    <div class="bg-white p-3 rounded">
                        <div class="text-sm font-medium">API 載入狀態</div>
                        <div id="api-status" class="text-xs text-gray-500">檢查中...</div>
                    </div>
                    <div class="bg-white p-3 rounded">
                        <div class="text-sm font-medium">DOM 就緒狀態</div>
                        <div id="dom-status" class="text-xs text-gray-500">檢查中...</div>
                    </div>
                    <div class="bg-white p-3 rounded">
                        <div class="text-sm font-medium">圖示載入狀態</div>
                        <div id="icons-status" class="text-xs text-gray-500">檢查中...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let testResults = [];
        let isRunning = false;

        // 測試結果管理
        class TestManager {
            addResult(test, status, details = '') {
                const result = {
                    test,
                    status,
                    details,
                    timestamp: new Date().toLocaleTimeString(),
                    duration: Date.now() - this._startTime
                };

                testResults.push(result);
                this.renderResults();
                console.log(`${this.getStatusIcon(status)} ${test}: ${details}`);
            }

            getStatusIcon(status) {
                return status === 'PASS' ? '✅' : status === 'FAIL' ? '❌' : '⚠️';
            }

            renderResults() {
                const container = document.getElementById('test-results');
                const summaryDiv = document.getElementById('test-summary');

                container.innerHTML = testResults.map((result, index) => {
                    const statusClass = result.status.toLowerCase().replace('pass', 'test-pass')
                        .replace('fail', 'test-fail').replace('warn', 'test-warn');
                    return `
                        <div class="p-3 rounded ${statusClass}">
                            <div class="flex justify-between items-center">
                                <span class="font-medium">${result.test}</span>
                                <span class="text-xs opacity-75">${result.timestamp}</span>
                            </div>
                            ${result.details ? `<div class="text-xs mt-1">${result.details}</div>` : ''}
                        </div>
                    `;
                }).join('');

                // 更新統計
                const total = testResults.length;
                const passed = testResults.filter(r => r.status === 'PASS').length;
                const failed = testResults.filter(r => r.status === 'FAIL').length;
                const warned = testResults.filter(r => r.status === 'WARN').length;

                document.getElementById('total-tests').textContent = total;
                document.getElementById('passed-tests').textContent = passed;
                document.getElementById('failed-tests').textContent = failed;
                document.getElementById('warning-tests').textContent = warned;

                summaryDiv.style.display = 'block';
            }

            async delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        const testManager = new TestManager();

        // 檢查主頁狀態
        function checkMainPageStatus() {
            try {
                // API 狀態
                if (typeof ZiweiCalculatorAPI !== 'undefined') {
                    document.getElementById('api-status').innerHTML =
                        '<span class="text-green-600">✅ 已載入</span>';
                } else {
                    document.getElementById('api-status').innerHTML =
                        '<span class="text-red-600">❌ 未載入</span>';
                }

                // DOM 狀態
                const keyElements = [
                    'user-name',
                    'gender-male',
                    'gender-female',
                    'birth-year',
                    'calculate-text'
                ];

                const foundElements = keyElements.filter(id => document.getElementById(id));
                document.getElementById('dom-status').innerHTML =
                    `<span class="text-blue-600">${foundElements.length}/${keyElements.length}</span>`;

                // 圖示狀態
                const hasLucide = document.querySelector('script[src*="lucide"]');
                document.getElementById('icons-status').innerHTML =
                    hasLucide ? '<span class="text-green-600">✅ 已載入</span>' :
                        '<span class="text-orange-600">⚠️ 未檢測到</span>';

            } catch (error) {
                console.error('狀態檢查錯誤:', error);
            }
        }

        // 測試按鈕功能
        async function testButtons() {
            if (isRunning) return;
            isRunning = true;
            testManager._startTime = Date.now();

            testManager.addResult('按鈕測試開始', 'INFO', '開始測試按鈕互動功能');

            try {
                await testManager.delay(100);

                // 測試性別按鈕
                const maleBtn = document.getElementById('gender-male');
                const femaleBtn = document.getElementById('gender-female');

                if (maleBtn && femaleBtn) {
                    // 模擬點擊男
                    maleBtn.click();
                    await testManager.delay(50);

                    if (maleBtn.classList.contains('bg-blue-500')) {
                        testManager.addResult('男性按鈕測試', 'PASS', '男性按鈕狀態正確');
                    } else {
                        testManager.addResult('男性按鈕測試', 'FAIL', '男性按鈕狀態異常');
                    }

                    // 模擬點擊女
                    femaleBtn.click();
                    await testManager.delay(50);

                    if (femaleBtn.classList.contains('bg-blue-500')) {
                        testManager.addResult('女性按鈕測試', 'PASS', '女性按鈕狀態正確');
                    } else {
                        testManager.addResult('女性按鈕測試', 'FAIL', '女性按鈕狀態異常');
                    }
                } else {
                    testManager.addResult('性別按鈕測試', 'FAIL', '性別按鈕元素未找到');
                }

                await testManager.delay(100);

                // 測試曆法按鈕
                const lunarBtn = document.getElementById('calendar-lunar');
                const solarBtn = document.getElementById('calendar-solar');

                if (lunarBtn && solarBtn) {
                    lunarBtn.click();
                    await testManager.delay(50);

                    if (lunarBtn.classList.contains('bg-green-500')) {
                        testManager.addResult('農曆按鈕測試', 'PASS', '農曆按鈕狀態正確');
                    } else {
                        testManager.addResult('農曆按鈕測試', 'FAIL', '農曆按鈕狀態異常');
                    }

                    solarBtn.click();
                    await testManager.delay(50);

                    if (solarBtn.classList.contains('bg-green-500')) {
                        testManager.addResult('西曆按鈕測試', 'PASS', '西曆按鈕狀態正確');
                    } else {
                        testManager.addResult('西曆按鈕測試', 'FAIL', '西曆按鈕狀態異常');
                    }
                } else {
                    testManager.addResult('曆法按鈕測試', 'FAIL', '曆法按鈕元素未找到');
                }

            } catch (error) {
                testManager.addResult('按鈕測試異常', 'FAIL', error.message);
            } finally {
                isRunning = false;
            }
        }

        // 測試表單驗證
        async function testFormValidation() {
            if (isRunning) return;
            isRunning = true;
            testManager._startTime = Date.now();

            testManager.addResult('表單驗證測試開始', 'INFO', '測試表單驗證功能');

            try {
                // 清空表單
                document.getElementById('user-name').value = '';
                document.getElementById('birth-year').value = '';
                document.getElementById('birth-month').value = '';
                document.getElementById('birth-day').value = '';
                document.getElementById('birth-hour').value = '';

                // 測試空表單驗證
                const calcButton = document.querySelector('button[onclick="calculateDestiny()"]');
                if (calcButton) {
                    calcButton.click();
                    await testManager.delay(100);

                    // 檢查是否有驗證提示（通過檢查 alert 或表單狀態）
                    testManager.addResult('空表單驗證', 'PASS', '空表單驗證觸發');
                }

                // 測試部分填寫
                document.getElementById('user-name').value = '測試用戶';
                document.getElementById('birth-year').value = '1990';

                if (calcButton) {
                    calcButton.click();
                    await testManager.delay(100);
                    testManager.addResult('部分填寫驗證', 'PASS', '部分填寫驗證觸發');
                }

                // 測試完整填寫
                document.getElementById('user-name').value = '測試用戶';
                document.getElementById('birth-year').value = '1990';
                document.getElementById('birth-month').value = '5';
                document.getElementById('birth-day').value = '15';
                document.getElementById('birth-hour').value = '午時';

                if (calcButton) {
                    testManager.addResult('完整表單測試', 'PASS', '表單已完整填寫，準備計算');
                }

            } catch (error) {
                testManager.addResult('表單驗證測試異常', 'FAIL', error.message);
            } finally {
                isRunning = false;
            }
        }

        // 測試計算功能
        async function testCalculation() {
            if (isRunning) return;
            isRunning = true;
            testManager._startTime = Date.now();

            testManager.addResult('計算功能測試開始', 'INFO', '測試紫微斗數計算功能');

            try {
                // 確保 API 已載入
                if (typeof ZiweiCalculatorAPI === 'undefined') {
                    testManager.addResult('API 載入檢查', 'FAIL', 'ZiweiCalculatorAPI 未定義');
                    return;
                }
                testManager.addResult('API 載入檢查', 'PASS', 'ZiweiCalculatorAPI 已載入');

                // 測試計算
                const testInput = {
                    name: '測試用戶',
                    gender: 'M',
                    birthYear: 1990,
                    birthMonth: 5,
                    birthDay: 15,
                    birthHour: '午時',
                    calendarType: 'solar',
                    isLeapMonth: false
                };

                const result = ZiweiCalculatorAPI.calculateDestiny(testInput);

                if (result.success) {
                    testManager.addResult('紫微斗數計算', 'PASS',
                        `計算成功！獲得 ${result.destinyInfo.palaces.length} 個宮位配置`);
                } else {
                    testManager.addResult('紫微斗數計算', 'FAIL', `計算失敗: ${result.error}`);
                }

                // 測試資料完整性
                if (result.success && result.destinyInfo) {
                    const palaces = result.destinyInfo.palaces;
                    const hasAllPalaces = palaces && palaces.length === 12;

                    if (hasAllPalaces) {
                        testManager.addResult('十二宮位檢查', 'TALK', '十二宮位配置完整');
                    } else {
                        testManager.addResult('十二宮位檢查', 'WARN', `宮位數量: ${palaces ? palaces.length : 0}`);
                    }
                }

            } catch (error) {
                testManager.addResult('計算功能測試異常', 'FAIL', error.message);
            } finally {
                isRunning = false;
            }
        }

        // 執行全部測試
        async function runAllTests() {
            if (isRunning) return;
            isRunning = true;
            testResults = [];
            testManager._startTime = Date.now();

            testManager.addResult('自動化測試套件', 'INFO', '開始執行完整的端到端測試');

            try {
                await testManager.delay(200);
                await testButtons();
                await testManager.delay(200);
                await testFormValidation();
                await testManager.delay(200);
                await testCalculation();

                testManager.addResult('測試套件完成', 'PASS',
                    `所有測試執行完畢，共完成 ${testResults.length} 項測試`);

            } catch (error) {
                testManager.addResult('測試套件異常', 'FAIL', error.message);
            } finally {
                isRunning = false;
            }
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function () {
            // 定期檢查主頁狀態
            setInterval(checkMainPageStatus, 2000);
            checkMainPageStatus();

            console.log('🧪 端到端測試系統已載入');
        });
    </script>
</body>

</html>
