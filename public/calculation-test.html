<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç´«å¾®æ–—æ•¸è¨ˆç®—æ¸¬è©¦</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="./api/destiny-calculator.js"></script>
</head>

<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-3xl font-bold text-blue-600 mb-6">ğŸ§ª ç´«å¾®æ–—æ•¸è¨ˆç®—è³‡æ–™æµç¨‹æ¸¬è©¦</h1>

            <!-- æ¸¬è©¦è¡¨å–® -->
            <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                <h2 class="text-xl font-bold mb-4">æ¸¬è©¦è¨ˆç®—è³‡æ–™</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">å§“å</label>
                        <input type="text" id="test-name" class="w-full p-2 border rounded" value="æ¸¬è©¦ä½¿ç”¨è€…">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">æ€§åˆ¥</label>
                        <select id="test-gender" class="w-full p-2 border rounded">
                            <option value="M">ç”·æ€§</option>
                            <option value="F">å¥³æ€§</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">å‡ºç”Ÿå¹´</label>
                        <input type="number" id="test-year" class="w-full p-2 border rounded" value="1990">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">å‡ºç”Ÿæœˆ</label>
                        <input type="number" id="test-month" class="w-full p-2 border rounded" value="5">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">å‡ºç”Ÿæ—¥</label>
                        <input type="number" id="test-day" class="w-full p-2 border rounded" value="15">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">å‡ºç”Ÿæ™‚è¾°</label>
                        <select id="test-hour" class="w-full p-2 border rounded">
                            <option value="å­æ™‚">å­æ™‚</option>
                            <option value="ä¸‘æ™‚">ä¸‘æ™‚</option>
                            <option value="å¯…æ™‚">å¯…æ™‚</option>
                            <option value="å¯æ™‚">å¯æ™‚</option>
                            <option value="è¾°æ™‚">è¾°æ™‚</option>
                            <option value="å·³æ™‚">å·³æ™‚</option>
                            <option value="åˆæ™‚" selected>åˆæ™‚</option>
                            <option value="æœªæ™‚">æœªæ™‚</option>
                            <option value="ç”³æ™‚">ç”³æ™‚</option>
                            <option value="é…‰æ™‚">é…‰æ™‚</option>
                            <option value="æˆŒæ™‚">æˆŒæ™‚</option>
                            <option value="äº¥æ™‚">äº¥æ™‚</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">æ›†æ³•é¡å‹</label>
                        <select id="test-calendar" class="w-full p-2 border rounded">
                            <option value="solar">è¥¿æ›†</option>
                            <option value="lunar">è¾²æ›†</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="testCalculation()"
                            class="bg-green-500 text-white px-6 py-2 rounded hover:bg-green-600 transition-colors w-full">
                            ğŸ§® æ¸¬è©¦è¨ˆç®—
                        </button>
                    </div>
                </div>
            </div>

            <!-- æ¸¬è©¦çµæœ -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h2 class="text-xl font-bold mb-4">æ¸¬è©¦çµæœ</h2>
                <div id="test-results" class="space-y-4">
                    <div class="text-gray-500">é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹æ¸¬è©¦...</div>
                </div>
            </div>

            <!-- åŸå§‹è³‡æ–™é¡¯ç¤º -->
            <div class="mt-4 bg-yellow-50 p-4 rounded-lg">
                <h3 class="text-lg font-bold mb-2">ğŸ“Š åŸå§‹è¨ˆç®—è³‡æ–™</h3>
                <pre id="raw-data" class="bg-gray-100 p-4 rounded text-sm overflow-auto max-h-96">
ç­‰å¾…æ¸¬è©¦...
                </pre>
            </div>
        </div>
    </div>

    <script>
        async function testCalculation() {
            console.log('ğŸ§ª é–‹å§‹æ¸¬è©¦è¨ˆç®—æµç¨‹...');

            // æ”¶é›†æ¸¬è©¦è³‡æ–™
            const testData = {
                name: document.getElementById('test-name').value,
                gender: document.getElementById('test-gender').value,
                birthYear: parseInt(document.getElementById('test-year').value),
                birthMonth: parseInt(document.getElementById('test-month').value),
                birthDay: parseInt(document.getElementById('test-day').value),
                birthHour: document.getElementById('test-hour').value,
                calendarType: document.getElementById('test-calendar').value,
                isLeapMonth: false
            };

            console.log('ğŸ” æ¸¬è©¦è³‡æ–™:', testData);

            // é¡¯ç¤ºåŸå§‹è³‡æ–™
            document.getElementById('raw-data').textContent = JSON.stringify(testData, null, 2);

            // æª¢æŸ¥ API æ˜¯å¦å¯ç”¨
            const apiAvailable = typeof ZiweiCalculatorAPI !== 'undefined';
            document.getElementById('test-results').innerHTML = `
                <div class="p-4 rounded ${apiAvailable ? 'bg-green-100' : 'bg-red-100'}">
                    <h3 class="font-bold">${apiAvailable ? 'âœ…' : 'âŒ'} API æª¢æŸ¥</h3>
                    <p>ZiweiCalculatorAPI ${apiAvailable ? 'å·²è¼‰å…¥' : 'æœªè¼‰å…¥'}</p>
                </div>
            `;

            if (!apiAvailable) {
                console.error('âŒ ZiweiCalculatorAPI ä¸å¯ç”¨');
                return;
            }

            try {
                console.log('ğŸ”„ èª¿ç”¨è¨ˆç®— API...');
                const result = ZiweiCalculatorAPI.calculateDestiny(testData);

                console.log('ğŸ“‹ è¨ˆç®—çµæœ:', result);

                // é¡¯ç¤ºçµæœ
                if (result && result.success) {
                    displaySuccessResult(result);
                } else {
                    displayFailureResult(result);
                }

            } catch (error) {
                console.error('âŒ è¨ˆç®—éç¨‹å‡ºéŒ¯:', error);
                document.getElementById('test-results').innerHTML += `
                    <div class="p-4 rounded bg-red-100">
                        <h3 class="font-bold text-red-800">âŒ è¨ˆç®—éŒ¯èª¤</h3>
                        <p class="text-red-700">${error.message}</p>
                        <details class="mt-2">
                            <summary class="cursor-pointer text-sm">è©³ç´°éŒ¯èª¤è³‡è¨Š</summary>
                            <pre class="mt-2 p-2 bg-red-50 rounded text-xs">${error.stack}</pre>
                        </details>
                    </div>
                `;
            }
        }

        function displaySuccessResult(result) {
            const destinyInfo = result.destinyInfo;
            let palaceInfo = '';

            if (destinyInfo.palaces && destinyInfo.palaces.length > 0) {
                palaceInfo = destinyInfo.palaces.map((palace, index) => {
                    const palaceName = palace.palaceName || palace.name || `å®®ä½ ${index + 1}`;
                    const majorStars = Array.isArray(palace.majorStars)
                        ? palace.majorStars.map(star => star.name || star).join('ã€')
                        : palace.majorStars || 'ç´«å¾®';
                    const energy = palace.energy ||
                        (Array.isArray(palace.majorStars) && palace.majorStars.length > 0
                            ? Math.floor(palace.majorStars.reduce((sum, star) => sum + (star.energyLevel || 50), 0) / palace.majorStars.length)
                            : 50);
                    return `${palaceName}: ${majorStars} (èƒ½é‡: ${energy}%)`;
                }).join('\n');
            } else {
                palaceInfo = 'ç„¡å®®ä½è³‡æ–™';
            }

            document.getElementById('test-results').innerHTML += `
                <div class="p-4 rounded bg-green-100">
                    <h3 class="font-bold text-green-800">âœ… è¨ˆç®—æˆåŠŸ</h3>
                    <div class="grid grid-cols-2 gap-4 mt-2">
                        <div>
                            <p class="text-sm"><strong>å§“å:</strong> ${destinyInfo.userInfo?.name || 'æœªçŸ¥'}</p>
                            <p class="text-sm"><strong>æ€§åˆ¥:</strong> ${destinyInfo.userInfo?.gender === 'M' ? 'ç”·æ€§' : 'å¥³æ€§'}</p>
                            <p class="text-sm"><strong>ç”Ÿè¾°:</strong> ${destinyInfo.userInfo?.birthYear || 'æœªçŸ¥'}å¹´ ${destinyInfo.userInfo?.birthMonth || 'æœªçŸ¥'}æœˆ ${destinyInfo.userInfo?.birthDay || 'æœªçŸ¥'}æ—¥</p>
                        </div>
                        <div>
                            <p class="text-sm"><strong>å‘½ä¸»æ˜Ÿ:</strong> ${destinyInfo.destinyMaster || 'æœªçŸ¥'}</p>
                            <p class="text-sm"><strong>èº«ä¸»æ˜Ÿ:</strong> ${destinyInfo.bodyMaster || 'æœªçŸ¥'}</p>
                            <p class="text-sm"><strong>äº”è¡Œ:</strong> ${destinyInfo.element || 'æœªçŸ¥'}</p>
                        </div>
                    </div>
                    <div class="mt-2">
                        <p class="text-sm font-medium">å®®ä½æ•¸é‡: ${destinyInfo.palaces?.length || 0}</p>
                        <details class="mt-1">
                            <summary class="cursor-pointer text-sm text-green-700">æŸ¥çœ‹å®®ä½è©³æƒ…</summary>
                            <pre class="mt-2 p-2 bg-green-50 rounded text-xs max-h-32 overflow-auto">${palaceInfo}</pre>
                        </details>
                    </div>
                </div>
            `;
        }

        function displayFailureResult(result) {
            document.getElementById('test-results').innerHTML += `
                <div class="p-4 rounded bg-red-100">
                    <h3 class="font-bold text-red-800">âŒ è¨ˆç®—å¤±æ•—</h3>
                    <p class="text-red-700">${result?.error || 'æœªçŸ¥éŒ¯èª¤'}</p>
                </div>
            `;
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            console.log('ğŸ§ª ç´«å¾®æ–—æ•¸è¨ˆç®—æ¸¬è©¦é é¢å·²è¼‰å…¥');

            // æª¢æŸ¥ API ç‹€æ…‹
            if (typeof ZiweiCalculatorAPI !== 'undefined') {
                console.log('âœ… ZiweiCalculatorAPI å·²è¼‰å…¥');
            } else {
                console.log('âŒ ZiweiCalculatorAPI æœªè¼‰å…¥');
            }
        });
    </script>
</body>

</html>